

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xpsi.Photosphere &mdash; xpsi 0.4.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> xpsi
          

          
          </a>

          
            
            
              <div class="version">
                0.4
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model_construction.html">Modelling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregion_complexity.html">Hot region complexity</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../global_surface_emission.html">Global surface emission</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_job.html">Example job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Extension modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parameter.html">Parameter</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pulse.html">Pulse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../everywhere.html">Everywhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing.html">PostProcessing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xpsi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>xpsi.Photosphere</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xpsi.Photosphere</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">.global_imports</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">global_imports</span>

<span class="kn">from</span> <span class="nn">.Spacetime</span> <span class="kn">import</span> <span class="n">Spacetime</span>
<span class="kn">from</span> <span class="nn">.HotRegion</span> <span class="kn">import</span> <span class="n">HotRegion</span>
<span class="kn">from</span> <span class="nn">.Elsewhere</span> <span class="kn">import</span> <span class="n">Elsewhere</span>
<span class="kn">from</span> <span class="nn">.Everywhere</span> <span class="kn">import</span> <span class="n">Everywhere</span>

<span class="kn">from</span> <span class="nn">.Parameter</span> <span class="kn">import</span> <span class="n">Parameter</span>
<span class="kn">from</span> <span class="nn">.ParameterSubspace</span> <span class="kn">import</span> <span class="n">ParameterSubspace</span>

<span class="kn">from</span> <span class="nn">.pixelmesh.integrator</span> <span class="kn">import</span> <span class="n">integrate</span> <span class="k">as</span> <span class="n">_integrate</span>
<span class="kn">from</span> <span class="nn">.tools.energy_integrator</span> <span class="kn">import</span> <span class="n">energy_integrator</span>
<span class="kn">from</span> <span class="nn">.tools.phase_integrator</span> <span class="kn">import</span> <span class="n">phase_integrator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="n">_mpl</span>
<span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
    <span class="k">pass</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">matplotlib</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
    <span class="kn">from</span> <span class="nn">matplotlib.figure</span> <span class="kn">import</span> <span class="n">Figure</span>
    <span class="kn">from</span> <span class="nn">matplotlib.backends.backend_agg</span> <span class="kn">import</span> <span class="n">FigureCanvasAgg</span> <span class="k">as</span> <span class="n">FigureCanvas</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">rcParams</span>
    <span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="kn">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">gridspec</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
    <span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span>
    <span class="kn">import</span> <span class="nn">matplotlib.image</span> <span class="k">as</span> <span class="nn">mgimg</span>

<div class="viewcode-block" id="Photosphere"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere">[docs]</a><span class="k">class</span> <span class="nc">Photosphere</span><span class="p">(</span><span class="n">ParameterSubspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A photosphere embedded in an ambient Schwarzschild spacetime.</span>

<span class="sd">    :param obj hot:</span>
<span class="sd">        An instance of :class:`~.HotRegion.HotRegion` (or a</span>
<span class="sd">        derived class). This objects represents the hot</span>
<span class="sd">        regions of the surface that in most use-cases will be</span>
<span class="sd">        assumed to contain radiating material that is hotter</span>
<span class="sd">        than that *elsewhere*.</span>

<span class="sd">    :param obj elsewhere:</span>
<span class="sd">        An instance of :class:`~.Elsewhere.Elsewhere` (or a derived class).</span>

<span class="sd">    :param obj everywhere:</span>
<span class="sd">        An instance of :class:`~.Everywhere.Everywhere` (or a derived class).</span>
<span class="sd">        Note that if you use construct the surface radiation field in this</span>
<span class="sd">        way, you should use the :attr:`~.Photosphere.Photosphere.hot_atmosphere`</span>
<span class="sd">        property to pass a buffer of numerical data to the integrator</span>
<span class="sd">        routines. You then need to ensure that the extension modules</span>
<span class="sd">        ``xpsi/surface_radiation_field/hot_radiation_field.pyx`` and</span>
<span class="sd">        ``xpsi/surface_radiation_field/elsewhere_radiation_field.pyx`` match.</span>

<span class="sd">    .. note::</span>

<span class="sd">        You cannot specify the surface radiation field *everywhere* if you</span>
<span class="sd">        use hot regions (the latter usage may also include specification of</span>
<span class="sd">        the radiation field *elsewhere*).</span>

<span class="sd">    :param dict bounds:</span>
<span class="sd">        Bounds are supplied for instantiation of a frequency parameter.</span>
<span class="sd">        The parameter name ``&#39;mode_frequency&#39;`` must be a key in the</span>
<span class="sd">        dictionary unless the parameter is *fixed* or *derived*. If a bound</span>
<span class="sd">        is ``None`` that bound is set equal to a strict hard-coded bound.</span>
<span class="sd">        If ``None``, lock the coordinate rotation frequency of a mode of</span>
<span class="sd">        asymmetry in the photosphere to a fixed frequency, e.g., the stellar</span>
<span class="sd">        rotation frequency. If bounds are passed, the frequency is interpreted</span>
<span class="sd">        as a free parameter.</span>

<span class="sd">    :param dict values:</span>
<span class="sd">        Either the fixed value of the mode frequency, a callable if the</span>
<span class="sd">        frequency is *derived*, or a value upon initialisation if the</span>
<span class="sd">        frequency is free. The dictionary must have a key with name</span>
<span class="sd">        ``&#39;mode_frequency&#39;`` if it is *fixed* or *derived*.</span>
<span class="sd">        If the asymmetry is locked to the stellar spin, then you need to pass</span>
<span class="sd">        the spin frequency. If fixed but different to the spin frequency, this</span>
<span class="sd">        value needs to be passed instead. In the hot region base class this</span>
<span class="sd">        mode frequency is applied to normalise the ray lags instead of the</span>
<span class="sd">        stellar rotation frequency.</span>

<span class="sd">    .. note::</span>

<span class="sd">        In basic modelling patterns the frequency is the spin frequency,</span>
<span class="sd">        and thus you only need to explicitly pass the spin as ``value`` whilst</span>
<span class="sd">        leaving ``bounds`` to default. If the spin frequency happens to be a</span>
<span class="sd">        free parameter (perhaps with informative prior information), then</span>
<span class="sd">        pass a callable instead that can be used to get the spin frequency</span>
<span class="sd">        dynamically when the derived mode frequency variable is called for.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">required_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">hot</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">elsewhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">everywhere</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                 <span class="n">bounds</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">values</span> <span class="o">=</span> <span class="p">{},</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">hot</span> <span class="ow">or</span> <span class="n">elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot use hot region nor elsewhere &#39;</span>
                                 <span class="s1">&#39;functionality if constructing the &#39;</span>
                                 <span class="s1">&#39;radiation field everywhere.&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">everywhere</span><span class="p">,</span> <span class="n">Everywhere</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for everywhere object.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="o">=</span> <span class="n">everywhere</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="o">=</span> <span class="kc">None</span>

            <span class="k">if</span> <span class="n">elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">elsewhere</span><span class="p">,</span> <span class="n">Elsewhere</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for an elsewhere object.&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="o">=</span> <span class="n">elsewhere</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">if</span> <span class="n">hot</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;The photosphere must radiate.&#39;</span><span class="p">)</span>

                                              <span class="c1"># including derived classes</span>
            <span class="k">if</span> <span class="n">hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="n">HotRegion</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="s1">&#39;objects&#39;</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">hot</span><span class="p">,</span> <span class="s1">&#39;objects&#39;</span><span class="p">):</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HotRegion</span><span class="p">):</span>
                            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid object for the hot &#39;</span>
                                            <span class="s1">&#39;region(s).&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid object for the hot region(s).&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="o">=</span> <span class="n">hot</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span> <span class="o">=</span> <span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span> <span class="o">=</span> <span class="p">()</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Coordinate frequency of the mode of radiative asymmetry in the</span>
<span class="s2">        photosphere that is assumed to generate the pulsed signal [Hz].</span>
<span class="s2">        &quot;&quot;&quot;</span>
        <span class="n">mode_frequency</span> <span class="o">=</span> <span class="n">Parameter</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span>
                                   <span class="n">strict_bounds</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2000.0</span><span class="p">),</span>
                                   <span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span>
                                   <span class="n">doc</span> <span class="o">=</span> <span class="n">doc</span><span class="p">,</span>
                                   <span class="n">symbol</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$f_{\rm mode}$&#39;</span><span class="p">,</span>
                                   <span class="n">value</span> <span class="o">=</span> <span class="n">values</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">Photosphere</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">mode_frequency</span><span class="p">,</span>
                                          <span class="n">hot</span><span class="p">,</span> <span class="n">elsewhere</span><span class="p">,</span> <span class="n">everywhere</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hot_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the numerical atmosphere buffers for hot regions if used.</span>

<span class="sd">        To preload a numerical atmosphere into a buffer, subclass and</span>
<span class="sd">        overwrite the setter. The underscore attribute set by the setter</span>
<span class="sd">        must be an :math:`n`-tuple whose :math:`n^{th}` element is an</span>
<span class="sd">        :math:`(n-1)`-dimensional array flattened into a one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray`. The first :math:`n-1`</span>
<span class="sd">        elements of the :math:`n`-tuple must each be an ordered one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray` of parameter values for the purpose of</span>
<span class="sd">        multi-dimensional interpolation in the :math:`n^{th}` buffer. The</span>
<span class="sd">        first :math:`n-1` elements must be ordered to match the index</span>
<span class="sd">        arithmetic applied to the :math:`n^{th}` buffer. An example would be</span>
<span class="sd">        ``self._hot_atmosphere = (logT, logg, mu, logE, buf)``, where:</span>
<span class="sd">        ``logT`` is a logarithm of local comoving effective temperature;</span>
<span class="sd">        ``logg`` is a logarithm of effective surface gravity;</span>
<span class="sd">        ``mu`` is the cosine of the angle from the local surface normal;</span>
<span class="sd">        ``logE`` is a logarithm of the photon energy; and</span>
<span class="sd">        ``buf`` is a one-dimensional buffer of intensities of size given by</span>
<span class="sd">        the product of sizes of the first :math:`n-1` tuple elements.</span>

<span class="sd">        It is highly recommended that buffer preloading is used, instead</span>
<span class="sd">        of loading from disk in the customisable radiation field extension</span>
<span class="sd">        module, to avoid reading from disk for every signal</span>
<span class="sd">        (likelihood) evaluation. This can be a non-negligible waste of compute</span>
<span class="sd">        resources. By preloading in Python, the memory is allocated and</span>
<span class="sd">        references to that memory are not in general deleted until a sampling</span>
<span class="sd">        script exits and the kernel stops. The likelihood callback accesses</span>
<span class="sd">        the same memory upon each call without I/O.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span>

    <span class="nd">@hot_atmosphere</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">hot_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement if required. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement setter if required.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elsewhere_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the numerical atmosphere buffers for elsewhere if used.</span>

<span class="sd">        To preload a numerical atmosphere into a buffer, subclass and</span>
<span class="sd">        overwrite the setter. The underscore attribute set by the setter</span>
<span class="sd">        must be an :math:`n`-tuple whose :math:`n^{th}` element is an</span>
<span class="sd">        :math:`(n-1)`-dimensional array flattened into a one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray`. The first :math:`n-1`</span>
<span class="sd">        elements of the :math:`n`-tuple must each be an ordered one-dimensional</span>
<span class="sd">        :class:`numpy.ndarray` of parameter values for the purpose of</span>
<span class="sd">        multi-dimensional interpolation in the :math:`n^{th}` buffer. The</span>
<span class="sd">        first :math:`n-1` elements must be ordered to match the index</span>
<span class="sd">        arithmetic applied to the :math:`n^{th}` buffer. An example would be</span>
<span class="sd">        ``self._hot_atmosphere = (logT, logg, mu, logE, buf)``, where:</span>
<span class="sd">        ``logT`` is a logarithm of local comoving effective temperature;</span>
<span class="sd">        ``logg`` is a logarithm of effective surface gravity;</span>
<span class="sd">        ``mu`` is the cosine of the angle from the local surface normal;</span>
<span class="sd">        ``logE`` is a logarithm of the photon energy; and</span>
<span class="sd">        ``buf`` is a one-dimensional buffer of intensities of size given by</span>
<span class="sd">        the product of sizes of the first :math:`n-1` tuple elements.</span>

<span class="sd">        It is highly recommended that buffer preloading is used, instead</span>
<span class="sd">        of loading from disk in the customisable radiation field extension</span>
<span class="sd">        module, to avoid reading from disk for every signal</span>
<span class="sd">        (likelihood) evaluation. This can be a non-negligible waste of compute</span>
<span class="sd">        resources. By preloading in Python, the memory is allocated and</span>
<span class="sd">        references to that memory are not in general deleted until a sampling</span>
<span class="sd">        script exits and the kernel stops. The likelihood callback accesses</span>
<span class="sd">        the same memory upon each call without I/O.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span>

    <span class="nd">@elsewhere_atmosphere</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">elsewhere_atmosphere</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Implement if required. &quot;&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Implement setter if required.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">hot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.HotRegion.HotRegion`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">elsewhere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.Elsewhere.Elsewhere`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">everywhere</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the instance of :class:`~.Everywhere.Everywhere`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">spacetime</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return instance of :class:`~.Spacetime.Spacetime`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span>

    <span class="nd">@spacetime</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">spacetime</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Spacetime</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for spacetime object.&#39;</span><span class="p">)</span>
        <span class="c1"># otherwise store a reference to the spacetime object</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span> <span class="o">=</span> <span class="n">obj</span>

<div class="viewcode-block" id="Photosphere.embed"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.embed">[docs]</a>    <span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fast_total_counts</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Embed the photosphere in an ambient Schwarzschild spacetime.</span>

<span class="sd">        In other words, generate a discrete representation of the photospheric</span>
<span class="sd">        radiation field and the null mapping from the photosphere to infinity,</span>
<span class="sd">        for use in flux integrators called by distant observers.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                   <span class="bp">self</span><span class="p">,</span>
                                   <span class="n">threads</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span> <span class="n">threads</span><span class="p">)</span>

                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="p">,</span>
                                    <span class="n">fast_total_counts</span><span class="p">,</span>
                                    <span class="n">threads</span><span class="p">,</span>
                                    <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">_compute_cellParamVecs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">embed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">,</span>
                                <span class="n">fast_total_counts</span><span class="p">,</span>
                                <span class="n">threads</span><span class="p">)</span></div>

<div class="viewcode-block" id="Photosphere.integrate"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.integrate">[docs]</a>    <span class="k">def</span> <span class="nf">integrate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">energies</span><span class="p">,</span> <span class="n">threads</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Integrate over the photospheric radiation field.</span>

<span class="sd">        :param energies:</span>
<span class="sd">            A one-dimensional :class:`numpy.ndarray` of energies in keV.</span>

<span class="sd">        :param int threads:</span>
<span class="sd">            Number of ``OpenMP`` threads to spawn for pulse integration.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># temp var</span>
            <span class="n">t</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                           <span class="n">energies</span><span class="p">,</span>
                                           <span class="n">threads</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_invariant</span> <span class="o">=</span> <span class="n">t</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span> <span class="o">=</span> <span class="p">((</span><span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">t</span><span class="p">),</span>
                                    <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_everywhere</span><span class="o">.</span><span class="n">phases_in_cycles</span><span class="p">))),),)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_invariant</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span> <span class="o">=</span> <span class="p">((</span><span class="n">t</span><span class="p">,),)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">):</span> <span class="c1"># resolve energy container type</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                        <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_time_invariant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                                       <span class="n">_energies</span><span class="p">,</span>
                                                       <span class="n">threads</span><span class="p">,</span>
                                                       <span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span><span class="p">)</span>

            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_hot</span><span class="o">.</span><span class="n">integrate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span><span class="p">,</span>
                                                  <span class="n">energies</span><span class="p">,</span>
                                                  <span class="n">threads</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">,</span>
                                                  <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere_atmosphere</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">tuple</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">,)</span>

                <span class="c1"># add time-invariant component to first time-dependent component</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_elsewhere</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_invariant</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the stored pulse.</span>

<span class="sd">        :returns:</span>
<span class="sd">            *ndarray[m,n]*, where :math:`m` is the number of energies, and</span>
<span class="sd">            :math:`n` is the number of phases. Units are photon/s/keV; the</span>
<span class="sd">            distance is a fast parameter so the areal units are not yet</span>
<span class="sd">            factored in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">time_invariant</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the cached time-invariant signal.</span>

<span class="sd">        :returns:</span>
<span class="sd">            *ndarray[n]* containing the time-invariant signal at</span>
<span class="sd">            :math:`n` energies. Units are photon/s/keV. The distance is a</span>
<span class="sd">            fast parameter so the areal units are not yet factored in.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_time_invariant</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">global_variables</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a vector of global surface radiation field variables.</span>

<span class="sd">        :returns: An *ndarray[n]* of scalars required to evaluate variables</span>
<span class="sd">                  that control the radiation field w.r.t local comoving frames</span>
<span class="sd">                  across the stellar surface.</span>

<span class="sd">        The following code block is how one would pass the properties of a</span>
<span class="sd">        single-temperature circular ``HotRegion`` to the extension modules. If</span>
<span class="sd">        you have more than one ``HotRegion`` object merged into the subspace</span>
<span class="sd">        associated with the ``Photosphere`` object, they may each be prefixed,</span>
<span class="sd">        meaning that the set of parameter names below would need to be prefixed</span>
<span class="sd">        at the least, and unless you only want to image one ``HotRegion``, the</span>
<span class="sd">        parameters of the ``HotRegions`` object are required.</span>

<span class="sd">        .. highlight:: python</span>
<span class="sd">        .. code-block:: python</span>

<span class="sd">            return _np.array([self[&#39;super_colatitude&#39;],</span>
<span class="sd">                              self[&#39;phase_shift&#39;] * _2pi,</span>
<span class="sd">                              self[&#39;super_radius&#39;],</span>
<span class="sd">                              self[&#39;super_temperature&#39;]])</span>

<span class="sd">        The phase shift controls the initial rotational phase of the</span>
<span class="sd">        ``HotRegion`` when imaging commences.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="bp">self</span><span class="p">[</span><span class="s1">&#39;temperature&#39;</span><span class="p">]])</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s1">&#39;Subclass and provide an implementation.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the precomputed image information. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_images</span>

    <span class="nd">@images</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">images</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Store an *ndarray[i,j,k]* of images. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">images</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;All image information must be &#39;</span>
                                        <span class="s1">&#39;contained in ndarrays.&#39;</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;All image information must be &#39;</span>
                                        <span class="s1">&#39;contained in ndarrays.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;An iterable of objects containing image &#39;</span>
                            <span class="s1">&#39;information must be supplied.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">images</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">9</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There must be six ndarray objects specifing &#39;</span>
                             <span class="s1">&#39;image information.&#39;</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="s1">&#39;Image information element </span><span class="si">%i</span><span class="s1"> must have </span><span class="si">%i</span><span class="s1"> dimensions.&#39;</span>

        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">2</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">5</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">6</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">7</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">7</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">assert</span> <span class="n">images</span><span class="p">[</span><span class="mi">8</span><span class="p">]</span><span class="o">.</span><span class="n">ndim</span> <span class="o">==</span> <span class="mi">3</span><span class="p">,</span> <span class="n">msg</span> <span class="o">%</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_images</span> <span class="o">=</span> <span class="n">images</span>

<div class="viewcode-block" id="Photosphere.image"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere.image">[docs]</a>    <span class="k">def</span> <span class="nf">image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
              <span class="n">reimage</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">energies</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">phases</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
              <span class="n">sqrt_num_rays</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
              <span class="n">epsabs_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">,</span>
              <span class="n">epsrel_ray</span> <span class="o">=</span> <span class="mf">1.0e-12</span><span class="p">,</span>
              <span class="n">max_steps</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>
              <span class="n">init_step</span> <span class="o">=</span> <span class="mf">0.1</span><span class="p">,</span>
              <span class="n">image_plane_radial_increment_power</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
              <span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
              <span class="n">cache_intensities</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">plot_sky_maps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">sky_map_kwargs</span> <span class="o">=</span> <span class="p">{},</span>
              <span class="n">animate_sky_maps</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
              <span class="n">animate_kwargs</span> <span class="o">=</span> <span class="p">{}):</span>
        <span class="sd">&quot;&quot;&quot; Image the star as a function of phase and energy.</span>

<span class="sd">        :param bool reimage:</span>
<span class="sd">            Image the star. Ignored if there is no precomputed image information</span>
<span class="sd">            to plot.</span>

<span class="sd">        :param ndarray[n] energies:</span>
<span class="sd">            Energies in keV to evaluate incident specific intensities at.</span>

<span class="sd">        :param ndarray[m] phases:</span>
<span class="sd">            Phases in radians at which to evaluate incident specific</span>
<span class="sd">            intensities at.</span>

<span class="sd">        :param int sqrt_num_rays:</span>
<span class="sd">            Square-root of the number of rays. This is the level of</span>
<span class="sd">            discretisation in both a radial coordinate and a polar coordinate</span>
<span class="sd">            on an elliptical image plane.</span>

<span class="sd">        .. note::</span>

<span class="sd">            When the spacetime is static or extremely close to being static in</span>
<span class="sd">            a numerical context, at the resolutions we are interested in, we</span>
<span class="sd">            need to mitigate problems with rays that graze the pole</span>
<span class="sd">            infinitesimally close to the polar axis. In the vicinity of the</span>
<span class="sd">            polar coordinate singularity the ODE system is stiff and the</span>
<span class="sd">            solution is unstable. The most straightforward way to mitigate this</span>
<span class="sd">            is to perform a fallback forward Euler step for a ray that passes</span>
<span class="sd">            exactly through the pole, and use that ray as an approximation for</span>
<span class="sd">            the grazing ray that started very nearby on the image plane.</span>
<span class="sd">            Internally, if a ray intersects the image plane at</span>
<span class="sd">            :math:`x`-coordinate that is numerically very close to, but not</span>
<span class="sd">            exactly, zero (which would mean alignment to the rotational axis),</span>
<span class="sd">            it is approximated by a ray that intersects :math:`x=0`.</span>
<span class="sd">            Image-plane interpolation of quantities (such as intensity) for</span>
<span class="sd">            the purpose of visualisation will then smooth out any such</span>
<span class="sd">            artefacts.</span>

<span class="sd">            Moreover, as an additional measure against</span>
<span class="sd">            artefacts in the sky maps in the vicinity of the rotational pole,</span>
<span class="sd">            rays are distributed accordingingly. For example, if we request</span>
<span class="sd">            :math:`n=400` rays per dimension, a maximal spacing of the rays</span>
<span class="sd">            from the rotational axis is achieved by rotating the *spokes*</span>
<span class="sd">            of rays (by up to :math:`\pm\pi/n`) so that no spoke is</span>
<span class="sd">            aligned (or anti-aligned) with the :math:`y`-direction.</span>

<span class="sd">        :param float epsabs_ray:</span>
<span class="sd">            Absolute error tolerance per ray to adhere to during numerical</span>
<span class="sd">            integration.</span>

<span class="sd">        :param float epsrel_ray:</span>
<span class="sd">            Relative error tolerance per ray to adhere to during numerical</span>
<span class="sd">            integration.</span>

<span class="sd">        :param int max_steps:</span>
<span class="sd">            Maximum number of steps to permit per ray before forced termination</span>
<span class="sd">            of integration.</span>

<span class="sd">        :param float init_step:</span>
<span class="sd">            The initial *suggested* step size at the image plane for the</span>
<span class="sd">            affine parameter for each ray.</span>

<span class="sd">        :param float image_plane_radial_increment_power:</span>
<span class="sd">            Controls the behaviour of the radial discretisation.</span>
<span class="sd">            Higher values towards unity result in linear spacing of rays with</span>
<span class="sd">            the radial coordinate. Lower values towards zero squeeze the rays</span>
<span class="sd">            towards the visible stellar limb, which is necessary for resolving</span>
<span class="sd">            images of extended radiating elements. Values above unity are not</span>
<span class="sd">            recommended, and would squeeze rays towards the image-plane origin,</span>
<span class="sd">            compromising resolution at the stellar limb.</span>

<span class="sd">        :param int threads:</span>
<span class="sd">            Number of OpenMP threads to spawn for parallel blocks of code.</span>
<span class="sd">            Parallel blocks include ray integration to generate a global ray</span>
<span class="sd">            map from image plane to surface; and image calculation at a</span>
<span class="sd">            sequence of rotational phases..</span>

<span class="sd">        :param bool cache_intensities:</span>
<span class="sd">            Cache the photon specific intensity sky maps in memory, as a</span>
<span class="sd">            function of phase and energy? Defaults to ``False`` because this</span>
<span class="sd">            dominates memory consumption. You need to activate this option</span>
<span class="sd">            if you want to plot the sky maps (see below).</span>

<span class="sd">        :param bool plot_sky_maps:</span>
<span class="sd">            Plot (specific) intenity sky maps at a sequence of phases, or</span>
<span class="sd">            by averaging over phase. Maps can be made at one more energies</span>
<span class="sd">            or energy intervals. The images will be written to disk and</span>
<span class="sd">            can be used as frames in an animated sequence.</span>

<span class="sd">        :param dict sky_map_kwargs:</span>
<span class="sd">            Dictionary of keyword arguments passed to</span>
<span class="sd">            :meth:`~Photosphere._plot_sky_maps`. Refer to the associated</span>
<span class="sd">            method docstring for available options.</span>

<span class="sd">        :param bool animate_sky_maps:</span>
<span class="sd">            Compile images from disk into an animated sequence.</span>

<span class="sd">        :param dict animate_kwargs:</span>
<span class="sd">            Dictionary of keyword arguments passed to</span>
<span class="sd">            :meth:`~Photosphere._animate`. Refer to the associated</span>
<span class="sd">            method docstring for available options.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span> <span class="c1"># geometry shortcut saves characters</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">images</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: star will not be reimaged... assuming images &#39;</span>
                      <span class="s1">&#39;exist on disk.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">reimage</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">phases</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Imaging phases must be form an ndarray.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Imaging energies must be form an ndarray.&#39;</span><span class="p">)</span>

            <span class="n">images</span> <span class="o">=</span> <span class="n">_integrate</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">R</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">Omega</span><span class="p">,</span>
                                <span class="bp">self</span><span class="p">[</span><span class="s1">&#39;mode_frequency&#39;</span><span class="p">],</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">zeta</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">epsilon</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">a</span><span class="p">,</span> <span class="c1"># dimensionless spin</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="c1"># mass quadrupole</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">d</span><span class="p">,</span>
                                <span class="n">ref</span><span class="o">.</span><span class="n">i</span><span class="p">,</span>
                                <span class="n">sqrt_num_rays</span><span class="p">,</span>
                                <span class="n">epsabs_ray</span><span class="p">,</span>
                                <span class="n">epsrel_ray</span><span class="p">,</span>
                                <span class="n">max_steps</span><span class="p">,</span>
                                <span class="n">init_step</span><span class="p">,</span>
                                <span class="n">image_plane_radial_increment_power</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">global_variables</span><span class="p">,</span>
                                <span class="n">energies</span><span class="p">,</span>
                                <span class="n">phases</span><span class="p">,</span>
                                <span class="n">cache_intensities</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_hot_atmosphere</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;A numerical error arose during imaging &#39;</span>
                                <span class="s1">&#39;computation... terminating simulation.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># tuple elements:</span>
                <span class="c1">#   energy-phase resolved pulse (2D array)</span>
                <span class="c1">#   x coordinate on image plane (1D array)</span>
                <span class="c1">#   y coordinate on image plane (1D array)</span>
                <span class="c1">#   colatitude mapped to point (x,y) on image plane (1D array)</span>
                <span class="c1">#   azimuth mapped to point (x,y) on image plane (1D array)</span>
                <span class="c1">#   phase lag</span>
                <span class="c1">#   redshift</span>
                <span class="c1">#   aberrated ray angle to local surface normal</span>
                <span class="c1">#   energy-phase resolved specific intensity sky maps (3D array)</span>
                <span class="c1"># the last element is None if you do not cache intensities</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>

                <span class="c1"># transpose so pulse phase increments along columns</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

        <span class="k">if</span> <span class="n">plot_sky_maps</span> <span class="ow">or</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You need to cache intensity sky maps if you &#39;</span>
                                 <span class="s1">&#39;want to plot them.&#39;</span><span class="p">)</span>
            <span class="n">root_dir</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;root_dir&#39;</span><span class="p">,</span> <span class="s1">&#39;./images&#39;</span><span class="p">)</span>
            <span class="n">file_root</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;file_root&#39;</span><span class="p">,</span> <span class="s1">&#39;skymap&#39;</span><span class="p">)</span>
            <span class="n">file_root</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">file_root</span><span class="p">)</span>

            <span class="n">phase_average</span> <span class="o">=</span> <span class="n">sky_map_kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;phase_average&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">phase_average</span> <span class="ow">and</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Phase averaged sky maps cannot be animated.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">):</span>
                <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_0.png&#39;</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">Warning: at least one image file exists &#39;</span>
                      <span class="s1">&#39;in ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">root_dir</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Attempting to move image files to a subdirectory &#39;</span>
                      <span class="s1">&#39;of ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">root_dir</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span> <span class="c1"># to archive the existing image files</span>
                    <span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
                    <span class="n">obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="s1">&#39;__datetime__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="s1">&#39;archived_</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">temp</span><span class="p">)</span>
                    <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span>

                    <span class="n">image_files</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">root_dir</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">image_files</span><span class="p">:</span>
                        <span class="k">if</span> <span class="s1">&#39;.png&#39;</span> <span class="ow">in</span> <span class="n">image</span><span class="p">:</span>
                            <span class="n">_os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root_dir</span><span class="p">,</span> <span class="n">image</span><span class="p">),</span>
                                       <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">temp</span><span class="p">,</span> <span class="n">image</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Aborting: image files would be &#39;</span>
                                    <span class="s1">&#39;overwritten. </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span>  <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Image files archived in subdirectory ``</span><span class="si">%s</span><span class="s1">``.&#39;</span> <span class="o">%</span> <span class="n">temp</span><span class="p">)</span>

            <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sky_maps</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span>
                                               <span class="n">_phases</span> <span class="o">=</span> <span class="n">phases</span><span class="p">,</span>
                                               <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                                               <span class="n">_redraw</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">sky_map_kwargs</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Star was reimaged but sky maps were not &#39;</span>
                                 <span class="s1">&#39;plotted... aborting animation.&#39;</span><span class="p">)</span>

            <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_sky_maps</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span>
                                               <span class="n">_energies</span> <span class="o">=</span> <span class="n">energies</span><span class="p">,</span>
                                               <span class="n">_redraw</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                                               <span class="n">threads</span> <span class="o">=</span> <span class="n">threads</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">sky_map_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">animate_sky_maps</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_0.png&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="s1">&#39;No images located for animation.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">reimage</span><span class="p">:</span>
                <span class="n">num_frames</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">num_frames</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">phases</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;You need to declare the image phases &#39;</span>
                                    <span class="s1">&#39;in order to include all images from disk.&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_animate</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">,</span>
                          <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span><span class="p">,</span> <span class="o">**</span><span class="n">animate_kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Photosphere._plot_sky_maps"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere._plot_sky_maps">[docs]</a>    <span class="k">def</span> <span class="nf">_plot_sky_maps</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">_file_root</span><span class="p">,</span>
                       <span class="n">_phases</span><span class="p">,</span>
                       <span class="n">_energies</span><span class="p">,</span>
                       <span class="n">_redraw</span><span class="p">,</span>
                       <span class="n">threads</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                       <span class="n">panel_layout</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">panel_indices</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">phase_average</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">energy_bounds</span> <span class="o">=</span> <span class="p">[],</span>
                       <span class="n">num_levels</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
                       <span class="n">normalise_each_panel</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">invert</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">colormap</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span>
                       <span class="n">usetex</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">fontsize_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">tick_spacing</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.2</span><span class="p">,</span><span class="mf">1.0</span><span class="p">),</span>
                       <span class="n">tick_length_scaling</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="n">dpi_scale</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method for specific intensity sky map visualization.</span>

<span class="sd">        Uses Delaunay triangulation to create an irregular sky mesh and</span>
<span class="sd">        calculate photon (specific) intensity contours at a sequence of phases.</span>

<span class="sd">        Each figure generated contains a sequence of panels arranged in</span>
<span class="sd">        one or two spatial dimensions. Each panel is an intensity sky map,</span>
<span class="sd">        either at a particular energy or integrated over a finite energy</span>
<span class="sd">        interval. Panels cannot mix specific and integrated intensities. Only</span>
<span class="sd">        a some sequence of energy (intervals), in any order, can be identified</span>
<span class="sd">        as labelling panels in one or two spatial dimensions. Time (rotational</span>
<span class="sd">        phase), whilst it could be defined to label a sequence of panels, is</span>
<span class="sd">        only identified as a labelling a sequence of *figures*.</span>

<span class="sd">        Similarly, sequence of energies could be identified as a variable</span>
<span class="sd">        labelling a sequence of figures, but is not. Moreover, energy and time</span>
<span class="sd">        could label panels in to spatial dimensions, but such mixing is not</span>
<span class="sd">        permitted. Finally, variables controlling the source-receiver system</span>
<span class="sd">        could be identified as labels of panels and/or figures, but this</span>
<span class="sd">        is also not supported. More complicated rendering patterns may be</span>
<span class="sd">        supported in future versions, but for now can be achieved via</span>
<span class="sd">        custom extensions building off of the current functionality.</span>


<span class="sd">        :param str _file_root:</span>
<span class="sd">            Relative or absolute path to parent directory for images,</span>
<span class="sd">            extended with the root name for the image files. E.g., the</span>
<span class="sd">            default is ``./images/skymap``. You do not need to change this</span>
<span class="sd">            unless you wish to, and is otherwise reserved for internal use.</span>
<span class="sd">            You may supply a custom file path via keywords ``root_dir`` and</span>
<span class="sd">            ``file_root`` upon calling :meth:`~Photosphere.image`, which are</span>
<span class="sd">            concatenated appropriately.</span>

<span class="sd">        :param ndarray[n] _phases:</span>
<span class="sd">            The phases at which the star was imaged. This is handled</span>
<span class="sd">            internally, so do *not* pass a keyword argument. If phase averaging,</span>
<span class="sd">            the minimum and maximum phases must be zero and :math:`2\pi`</span>
<span class="sd">            radians (i.e., zero and one cycles).</span>

<span class="sd">        :param ndarray[n] _energies:</span>
<span class="sd">            The energies at which the star was imaged. This is handled</span>
<span class="sd">            internally, so do *not* pass a keyword argument.</span>

<span class="sd">        :param bool _redraw:</span>
<span class="sd">            Redraw the sky maps? This is handled internally, so do *not* pass</span>
<span class="sd">            a keyword argument.</span>

<span class="sd">        :param tuple[int,int] panel_layout:</span>
<span class="sd">            Two elements: the number of rows and columns of panels. If ``None``</span>
<span class="sd">            a layout is automatically determined based on the number of</span>
<span class="sd">            images to be plotted.</span>

<span class="sd">        :param iterable panel_indices:</span>
<span class="sd">            These ordered integers will be used to select intensity information</span>
<span class="sd">            by indexing the energy dimension of a 3D intensity array. If</span>
<span class="sd">            specific intensites are plotted, these integers should index</span>
<span class="sd">            a subset of energies at which the star was imaged. If intensities</span>
<span class="sd">            are plotted, these integers should index a subset of the energy</span>
<span class="sd">            intervals over which specific intensities are integrated. See</span>
<span class="sd">            the ``energy_bounds`` keyword argument.</span>

<span class="sd">        :param bool phase_average:</span>
<span class="sd">            Average each sky map over one revolution (cycle) in phase?</span>
<span class="sd">            Note that the resulting image is incompatible with the currently</span>
<span class="sd">            supported animation mode.</span>

<span class="sd">        :param iterable energy_bounds:</span>
<span class="sd">            A set of two-element containers. Each container has an ordered pair</span>
<span class="sd">            of energies which delimit an integration domain. Specific intensity</span>
<span class="sd">            is integrated along each sky direction, at each phase, between</span>
<span class="sd">            these energy bounds. The bounds must be between the minimum and</span>
<span class="sd">            maximum energies at which the star was imaged. If ``None``,</span>
<span class="sd">            specific intensity sky maps will be plotted (the default).</span>

<span class="sd">        :param int num_levels:</span>
<span class="sd">            Number of contour levels in (specific) intensity, distributed</span>
<span class="sd">            between minimum finite, and maximum values per panel, or over all</span>
<span class="sd">            panels. See ``normalise_each_panel`` keyword argument.</span>

<span class="sd">        :param bool normalise_each_panel:</span>
<span class="sd">            Normalise the contour grey scale to each panel uniquely, or</span>
<span class="sd">            globally over all panels? The former yields relative intensity</span>
<span class="sd">            as function of phase and sky direction for an energy or energy</span>
<span class="sd">            interval, whilst the latter offers more spectral information but</span>
<span class="sd">            emission in some panels may not be discernable.</span>

<span class="sd">        :param bool invert:</span>
<span class="sd">            Invert the greyscale to show bright pixels as dark on a white</span>
<span class="sd">            plot background. If a colormap is manually supplied, this just</span>
<span class="sd">            controls the plot background colour. Inversion is recommended</span>
<span class="sd">            for printed format, whilst a black background is more intuitive</span>
<span class="sd">            when in digital format.</span>

<span class="sd">        :param obj colormap:</span>
<span class="sd">            A matplotlib colormap object. Choose something appropriate and</span>
<span class="sd">            *accessible* for a non-negative scalar field (sky intensities).</span>

<span class="sd">        :param tuple(int,int) figsize:</span>
<span class="sd">            The figure size (width, height) in *inches*. If the dimensions are</span>
<span class="sd">            inconsistent with the aspect ratio suggested by the ``panel_layout``</span>
<span class="sd">            settings, the height of the figure will be automatically rescaled</span>
<span class="sd">            to achieve congruence, meaning each panel is approximately square.</span>

<span class="sd">        :param bool usetex:</span>
<span class="sd">            Use TeX backend for figure text.</span>

<span class="sd">        :param float fontsize_scale:</span>
<span class="sd">            Use this argument to scale the font size of figure text relative</span>
<span class="sd">            to the default font size that is automatically determined based</span>
<span class="sd">            on the approximate panel size, which is in turn based on the</span>
<span class="sd">            figure size and the panel layout.</span>

<span class="sd">        :param tuple[float,float] tick_spacing:</span>
<span class="sd">            A two-element container. The first element is the minor tick</span>
<span class="sd">            spacing, and the second is the major tick spacing, for both</span>
<span class="sd">            the :math:`x` and :math:`y` directions on the image plane. The</span>
<span class="sd">            units are gravitational radii (:math:`GM/c^2`).</span>

<span class="sd">        :param float tick_length_scaling:</span>
<span class="sd">            Use this argument to scale the axis tick lengths relative to the</span>
<span class="sd">            default lengths that are automatically determined based on the</span>
<span class="sd">            panel size.</span>

<span class="sd">        :param float dpi_scale:</span>
<span class="sd">            Use this argument to scale the dots per inch of the figure,</span>
<span class="sd">            relative to the default that is automatically determined based</span>
<span class="sd">            on the panel size.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_root</span> <span class="o">=</span> <span class="n">_file_root</span>
        <span class="n">phases</span> <span class="o">=</span> <span class="n">_phases</span>
        <span class="n">energies</span> <span class="o">=</span> <span class="n">_energies</span>
        <span class="n">redraw</span> <span class="o">=</span> <span class="n">_redraw</span>

        <span class="k">if</span> <span class="n">panel_layout</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">_m</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">_m</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">))))</span>
            <span class="k">if</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                <span class="n">panel_layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">panel_layout</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>

        <span class="c1"># try to improve the aspect ratio so that each panel is</span>
        <span class="c1"># approximately square</span>
        <span class="n">width</span> <span class="o">=</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">height</span> <span class="o">=</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.2</span>
        <span class="n">aspect_ratio</span> <span class="o">=</span> <span class="n">height</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">width</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">aspect_ratio</span> <span class="o">!=</span> <span class="mf">1.0</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">aspect_ratio</span><span class="p">)</span><span class="o">/</span><span class="n">aspect_ratio</span> <span class="o">&gt;</span> <span class="mf">0.1</span><span class="p">:</span>
               <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">aspect_ratio</span><span class="p">)</span>

        <span class="c1"># calculate an appropriate dpi to resolve each panel adequately</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">150.0</span> <span class="o">*</span> <span class="n">dpi_scale</span>

        <span class="k">if</span> <span class="n">redraw</span><span class="p">:</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">usetex</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Panel indices object must be iterable.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;There are too few panels for the requested &#39;</span>
                                 <span class="s1">&#39;number of intensity sky maps.&#39;</span><span class="p">)</span>

            <span class="c1"># some scaling for appropriate fontsize</span>
            <span class="n">panel_size</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span>
                             <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
            <span class="n">fontsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">panel_size</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">14.0</span> <span class="o">*</span> <span class="n">fontsize_scale</span>
            <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;font.size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fontsize</span><span class="p">)</span>

            <span class="n">tick_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">((</span><span class="n">panel_size</span><span class="o">/</span><span class="mf">5.0</span><span class="p">)</span> <span class="o">*</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">tick_length_scaling</span><span class="p">)</span>

            <span class="c1"># get coordinates of irregular set of points for triangulation</span>
            <span class="n">X</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">Y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">energies</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Imaging energies must be form an ndarray.&#39;</span><span class="p">)</span>

            <span class="n">images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">images</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">energy_bounds</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">bounds</span> <span class="ow">in</span> <span class="n">energy_bounds</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">bounds</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Energy bounds in a tuple must be &#39;</span>
                                         <span class="s1">&#39;ordered.&#39;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">bound</span> <span class="ow">in</span> <span class="n">bounds</span><span class="p">:</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">energies</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">bound</span> <span class="o">&lt;=</span> <span class="n">energies</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Extrapolation would be required.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Fewer panels than energy intervals.&#39;</span><span class="p">)</span>

                <span class="n">integrated</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                        <span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">),</span>
                                        <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span> <span class="c1"># phases</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c1"># sky directions</span>
                        <span class="n">intensities</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,:,</span><span class="n">j</span><span class="p">]</span>

                    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">energy_bounds</span><span class="p">)):</span>
                        <span class="n">a</span><span class="p">,</span> <span class="n">b</span> <span class="o">=</span> <span class="n">energy_bounds</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>
                        <span class="n">_integrated</span> <span class="o">=</span> <span class="n">energy_integrator</span><span class="p">(</span><span class="n">threads</span><span class="p">,</span>
                                                        <span class="n">intensities</span><span class="p">,</span>
                                                        <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">energies</span><span class="p">),</span>
                                                        <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">a</span><span class="p">),</span>
                                                        <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">b</span><span class="p">))</span>

                        <span class="n">integrated</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">k</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">_integrated</span><span class="p">[:]</span>

                <span class="n">images</span> <span class="o">=</span> <span class="n">integrated</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">energies</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Fewer panels than energies.&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">phase_average</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">phases</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">phases</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="n">_2pi</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Minimum and maximum phases at which star &#39;</span>
                                     <span class="s1">&#39;is imaged must be zero and unity if you &#39;</span>
                                     <span class="s1">&#39;are phase averaging.&#39;</span><span class="p">)</span>

                <span class="n">averaged</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">1</span><span class="p">,</span>
                                      <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                      <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                <span class="n">intensities</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                         <span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]),</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># energies</span>
                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span> <span class="c1"># sky directions</span>
                        <span class="n">intensities</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">images</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>

                    <span class="n">_averaged</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="c1"># exposure time</span>
                                                 <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span>
                                                 <span class="n">intensities</span><span class="p">,</span>
                                                 <span class="n">phases</span> <span class="o">/</span> <span class="n">_2pi</span><span class="p">,</span>
                                                 <span class="mf">0.0</span><span class="p">)</span> <span class="c1"># phase shift</span>

                    <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
                        <span class="n">averaged</span><span class="p">[:,</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">_averaged</span><span class="p">[</span><span class="n">j</span><span class="p">,:]</span>

                <span class="n">images</span> <span class="o">=</span> <span class="n">averaged</span>

            <span class="k">if</span> <span class="n">normalise_each_panel</span><span class="p">:</span> <span class="c1"># normalise intensity for each individual panel</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="p">[]</span>

                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span> <span class="c1"># at each energy</span>
                    <span class="c1"># find extreme intensities over discrete set of image phases</span>
                    <span class="c1"># and sky directions</span>
                    <span class="n">MIN</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:][</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">])</span>
                    <span class="n">MAX</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[:,</span><span class="n">j</span><span class="p">,:])</span>
                    <span class="n">levels</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span>
                                                                      <span class="n">MAX</span><span class="p">,</span>
                                                                      <span class="n">num_levels</span><span class="p">))))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">MIN</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">images</span><span class="p">[:,:,:][</span><span class="n">images</span><span class="p">[:,:,:]</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">])</span>
                <span class="n">MAX</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">images</span><span class="p">[:,:,:])</span>
                <span class="n">levels</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">MIN</span><span class="p">,</span>
                                                             <span class="n">MAX</span><span class="p">,</span>
                                                             <span class="n">num_levels</span><span class="p">)))</span>


            <span class="c1"># because of default tick formatting and a minus sign,</span>
            <span class="c1"># the left and bottom margins need to be different</span>
            <span class="n">left</span> <span class="o">=</span> <span class="mf">0.160</span> <span class="o">*</span> <span class="p">(</span><span class="n">fontsize</span><span class="o">/</span><span class="mf">28.0</span><span class="p">)</span>
            <span class="n">bottom</span> <span class="o">=</span> <span class="mf">0.125</span> <span class="o">*</span> <span class="p">(</span><span class="n">fontsize</span><span class="o">/</span><span class="mf">28.0</span><span class="p">)</span>
            <span class="n">right</span> <span class="o">=</span> <span class="mf">0.975</span>
            <span class="n">top</span> <span class="o">=</span> <span class="n">bottom</span> <span class="o">+</span> <span class="p">(</span><span class="n">right</span> <span class="o">-</span> <span class="n">left</span><span class="p">)</span>

            <span class="n">ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spacetime</span>

            <span class="n">cmap</span> <span class="o">=</span> <span class="n">colormap</span> <span class="ow">or</span> <span class="p">(</span><span class="n">cm</span><span class="o">.</span><span class="n">gray_r</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="n">cm</span><span class="o">.</span><span class="n">gray</span><span class="p">)</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">Figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span> <span class="c1">#plt.figure(figsize = figsize)</span>
            <span class="n">canvas</span> <span class="o">=</span> <span class="n">FigureCanvas</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

            <span class="n">gs</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">left</span><span class="o">=</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="n">right</span><span class="p">,</span>
                                   <span class="n">bottom</span><span class="o">=</span><span class="n">bottom</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="n">top</span><span class="p">,</span>
                                   <span class="n">wspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>

            <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">))]</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">images</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">idx</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">panel_indices</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">product</span><span class="p">(</span><span class="n">panel_layout</span><span class="p">)</span> <span class="o">-</span> <span class="n">j</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(2x/(3\sqrt</span><span class="si">{3}</span><span class="s1">r_{\rm s}))$&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(x/R_{\rm eq})\sqrt{1-r_{\rm s}/R_{\rm eq}}$&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">j</span> <span class="o">%</span> <span class="n">panel_layout</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">ref</span><span class="o">.</span><span class="n">R</span> <span class="o">&lt;</span> <span class="mf">1.5</span> <span class="o">*</span> <span class="n">ref</span><span class="o">.</span><span class="n">r_s</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(2y/(3\sqrt</span><span class="si">{3}</span><span class="s1">r_{\rm s}))$&#39;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$(y/R_{\rm eq})\sqrt{1-r_{\rm s}/R_{\rm eq}}$&#39;</span><span class="p">)</span>

                    <span class="n">_veneer</span><span class="p">(</span><span class="n">tick_spacing</span><span class="p">,</span> <span class="n">tick_spacing</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span>
                            <span class="n">length</span> <span class="o">=</span> <span class="n">tick_length</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_facecolor</span><span class="p">(</span><span class="s1">&#39;white&#39;</span> <span class="k">if</span> <span class="n">invert</span> <span class="k">else</span> <span class="s1">&#39;black&#39;</span><span class="p">)</span>

                    <span class="n">lvls</span> <span class="o">=</span> <span class="n">levels</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">levels</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="k">else</span> <span class="n">levels</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">tricontourf</span><span class="p">(</span><span class="n">X</span><span class="p">,</span>
                                   <span class="n">Y</span><span class="p">,</span>
                                   <span class="n">images</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">idx</span><span class="p">,:],</span>
                                   <span class="n">cmap</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">,</span>
                                   <span class="n">levels</span> <span class="o">=</span> <span class="n">lvls</span><span class="p">)</span>

                    <span class="c1"># correct the aspect ratio</span>
                    <span class="n">x_view</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()</span>
                    <span class="n">diff</span> <span class="o">=</span> <span class="n">x_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">x_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="n">x_view</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">,</span>
                                               <span class="n">x_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">)</span>
                    <span class="n">y_view</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_view_interval</span><span class="p">(</span><span class="n">y_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">1.025</span><span class="p">,</span>
                                               <span class="n">y_view</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">diff</span> <span class="o">*</span> <span class="mf">0.025</span><span class="p">)</span>

                <span class="n">fig</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">i</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>

            <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">cla</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figsize</span><span class="p">,</span> <span class="n">dpi</span></div>

<div class="viewcode-block" id="Photosphere._animate"><a class="viewcode-back" href="../../photosphere.html#xpsi.Photosphere.Photosphere._animate">[docs]</a>    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_animate</span><span class="p">(</span><span class="n">_file_root</span><span class="p">,</span> <span class="n">_num_frames</span><span class="p">,</span> <span class="n">_figsize</span><span class="p">,</span> <span class="n">_dpi</span><span class="p">,</span>
                 <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">repeat</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">repeat_delay</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">ffmpeg_path</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper method to animate the intensity sky maps.</span>

<span class="sd">        :param str _file_root:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _num_frames:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _figsize:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int _dpi:</span>
<span class="sd">            Reserved for internal use.</span>

<span class="sd">        :param int cycles:</span>
<span class="sd">            Number of explicit cycles to generate frames for. The frames from</span>
<span class="sd">            the principal cycle are reused, so the images are periodic in</span>
<span class="sd">            their phase evolution. There is no delay between cycles in this</span>
<span class="sd">            type of repitition.</span>

<span class="sd">        :param bool repeat:</span>
<span class="sd">            Inform *ffmpeg* to enter a loop when video play back commences.</span>

<span class="sd">        :param repeat_delay:</span>
<span class="sd">            Delay between repeats in milliseconds.</span>

<span class="sd">        :param str ffmpeg_path:</span>
<span class="sd">            Absolute path to *ffmpeg* executable. If ``None``, defaults</span>
<span class="sd">            to matplotlib rcParams settings, but no guarantee that the package</span>
<span class="sd">            will be found even if installed on system.</span>

<span class="sd">        :param int fps:</span>
<span class="sd">            Frames per second. If ``None``, then one cycle (assuming images</span>
<span class="sd">            have been precomputed for a complete cycle), consisting of</span>
<span class="sd">            so many frames, will exhibit a period of one second.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">file_root</span> <span class="o">=</span> <span class="n">_file_root</span>
        <span class="n">num_frames</span> <span class="o">=</span> <span class="n">_num_frames</span>
        <span class="n">figsize</span> <span class="o">=</span> <span class="n">_figsize</span>
        <span class="n">dpi</span> <span class="o">=</span> <span class="n">_dpi</span>

        <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="n">figsize</span><span class="p">)</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
        <span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">left</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">top</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                            <span class="n">wspace</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

        <span class="n">images</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_frames</span><span class="p">):</span> <span class="c1"># load phase-ordered set of images</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_</span><span class="si">%i</span><span class="s1">.png&#39;</span> <span class="o">%</span> <span class="n">i</span>
            <span class="n">img</span> <span class="o">=</span> <span class="n">mgimg</span><span class="o">.</span><span class="n">imread</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
            <span class="n">imgplot</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">img</span><span class="p">,</span> <span class="n">aspect</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
            <span class="n">imgplot</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">imgplot</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">imgplot</span><span class="p">])</span>

        <span class="n">cycles</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cycles</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">cycles</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">cycles</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">cycles</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cycles</span> <span class="o">-</span> <span class="mi">1</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_frames</span><span class="p">):</span>
                    <span class="n">images</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">images</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">ani</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">ArtistAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">images</span><span class="p">,</span>
                                        <span class="n">repeat</span> <span class="o">=</span> <span class="n">repeat</span><span class="p">,</span>
                                        <span class="n">repeat_delay</span> <span class="o">=</span> <span class="n">repeat_delay</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">ffmpeg_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: no path specified for ffmpeg executable. &#39;</span>
                  <span class="s1">&#39;Resorting to rcParams default.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;animation.ffmpeg_path&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ffmpeg_path</span>

        <span class="k">if</span> <span class="n">fps</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">fps</span> <span class="o">=</span> <span class="n">num_frames</span> <span class="c1"># all frames span one second</span>

        <span class="c1"># secret keyword argument; not clear whether should be exposed to user</span>
        <span class="n">bitrate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;bitrate&#39;</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;_animated.mp4&#39;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Writing to disk: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">filename</span><span class="p">)</span>
        <span class="n">ani</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">writer</span> <span class="o">=</span> <span class="s1">&#39;ffmpeg&#39;</span><span class="p">,</span>
                 <span class="n">dpi</span> <span class="o">=</span> <span class="n">dpi</span><span class="p">,</span> <span class="n">fps</span> <span class="o">=</span> <span class="n">fps</span><span class="p">,</span> <span class="n">bitrate</span> <span class="o">=</span> <span class="n">bitrate</span><span class="p">)</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span></div></div>

<span class="n">Photosphere</span><span class="o">.</span><span class="n">_update_doc</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">_veneer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">axes</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Make the plots a little more aesthetically pleasing. &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="n">axes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">length</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">axes</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">length</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">setp</span><span class="p">(</span><span class="n">axes</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">values</span><span class="p">(),</span> <span class="n">linewidth</span><span class="o">=</span><span class="n">lw</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">)</span>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Thomas E. Riley

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>