

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>xpsi.PostProcessing &mdash; xpsi 0.2.0-alpha documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"tex2jax": {"processClass": "math|output_area", "processEscapes": true, "ignoreClass": "document", "inlineMath": [["$", "$"], ["\\(", "\\)"]]}})</script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> xpsi
          

          
          </a>

          
            
            
              <div class="version">
                0.2
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">User Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../FAQ.html">(FA)Q</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../applications.html">Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../SURFsara_systems.html">SURFsara systems</a></li>
</ul>
<p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../model_construction.html">Model construction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_script.html">Example script and modules</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../example_job.html">Example job</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../extensions.html">Extension modules</a></li>
</ul>
<p class="caption"><span class="caption-text">Likelihood API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../parameterSpace.html">ParameterSpace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../parameterSubspace.html">ParameterSubspace</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../likelihood.html">Likelihood</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../pulse.html">Pulse</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../instrument.html">Instrument</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../data.html">Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../star.html">Star</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../spacetime.html">Spacetime</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../photosphere.html">Photosphere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregion.html">HotRegion</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../twohotregions.html">TwoHotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../hotregions.html">HotRegions</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../elsewhere.html">Elsewhere</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../interstellar.html">Interstellar</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../background.html">Background</a></li>
</ul>
<p class="caption"><span class="caption-text">Posterior API</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../prior.html">Prior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../posterior.html">Posterior</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../sample.html">Sample</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../postprocessing.html">PostProcessing</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xpsi</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>xpsi.PostProcessing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for xpsi.PostProcessing</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">__future__</span> <span class="k">import</span> <span class="n">division</span><span class="p">,</span> <span class="n">print_function</span>

<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Run&quot;</span><span class="p">,</span>
           <span class="s2">&quot;NSBackend&quot;</span><span class="p">,</span>
           <span class="s2">&quot;Runs&quot;</span><span class="p">,</span>
           <span class="s2">&quot;PostProcessor&quot;</span><span class="p">,</span>
           <span class="s2">&quot;publication_rc_settings&quot;</span><span class="p">,</span>
           <span class="s2">&quot;slide_rc_settings&quot;</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">.global_imports</span> <span class="k">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">global_imports</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">make_verbose</span><span class="p">,</span> <span class="n">verbose</span><span class="p">,</span> <span class="n">fragile</span><span class="p">,</span> <span class="n">_verbose</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">__version__</span>

<span class="kn">import</span> <span class="nn">six</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="k">import</span> <span class="n">wraps</span>

<span class="kn">import</span> <span class="nn">copy</span> <span class="k">as</span> <span class="nn">_copy</span>

<span class="kn">from</span> <span class="nn">scipy.special</span> <span class="k">import</span> <span class="n">logsumexp</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">pyplot</span> <span class="k">as</span> <span class="n">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">rc</span><span class="p">,</span> <span class="n">rcParams</span>
<span class="kn">from</span> <span class="nn">matplotlib.ticker</span> <span class="k">import</span> <span class="n">MultipleLocator</span><span class="p">,</span> <span class="n">MaxNLocator</span><span class="p">,</span> <span class="n">AutoMinorLocator</span><span class="p">,</span>\
                                <span class="n">AutoLocator</span><span class="p">,</span> <span class="n">ScalarFormatter</span><span class="p">,</span> <span class="n">LogLocator</span><span class="p">,</span>\
                                <span class="n">NullFormatter</span>

<span class="k">def</span> <span class="nf">_get_default_locator</span><span class="p">(</span><span class="n">prune</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">MaxNLocator</span><span class="p">(</span><span class="n">nbins</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">min_n_ticks</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">prune</span><span class="o">=</span><span class="n">prune</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">_get_default_formatter</span><span class="p">():</span>
    <span class="n">default</span> <span class="o">=</span> <span class="n">ScalarFormatter</span><span class="p">(</span><span class="n">useOffset</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">default</span><span class="o">.</span><span class="n">set_powerlimits</span><span class="p">(</span><span class="n">lims</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span><span class="mf">3.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">default</span>

<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">gridspec</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="k">import</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">matplotlib.patches</span> <span class="k">as</span> <span class="nn">mpatches</span>

<span class="kn">from</span> <span class="nn">.Likelihood</span> <span class="k">import</span> <span class="n">Likelihood</span>
<span class="kn">from</span> <span class="nn">.Prior</span> <span class="k">import</span> <span class="n">Prior</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="k">import</span> <span class="n">Pulse</span>
<span class="kn">from</span> <span class="nn">.tools.phase_interpolator</span> <span class="k">import</span> <span class="n">interpolate_pulse</span> <span class="k">as</span> <span class="n">interp</span>
<span class="kn">from</span> <span class="nn">.tools.phase_integrator</span> <span class="k">import</span> <span class="n">phase_integrator</span>
<span class="kn">from</span> <span class="nn">.tools.energy_interpolator</span> <span class="k">import</span> <span class="n">energy_interpolator</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">h5py</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot import h5py for caching.&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">getdist</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot import GetDist.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">getdist</span> <span class="k">import</span> <span class="n">loadMCSamples</span><span class="p">,</span> <span class="n">plots</span>
    <span class="c1"># the following disables getdist.chains.print_load_details</span>
    <span class="n">getdist</span><span class="o">.</span><span class="n">chains</span><span class="o">.</span><span class="n">print_load_details</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imported GetDist version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">getdist</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">nestcheck</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot import nestcheck.&#39;</span><span class="p">)</span>
<span class="k">else</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Imported nestcheck version: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">nestcheck</span><span class="o">.</span><span class="n">__version__</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">nestcheck.data_processing</span> <span class="k">import</span> <span class="p">(</span><span class="n">process_multinest_run</span><span class="p">,</span>
                                           <span class="n">process_polychord_run</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">nestcheck.ns_run_utils</span> <span class="k">import</span> <span class="n">combine_ns_runs</span><span class="p">,</span> <span class="n">get_logw</span><span class="p">,</span> <span class="n">get_w_rel</span>
    <span class="kn">from</span> <span class="nn">nestcheck.write_polychord_output</span> <span class="k">import</span> <span class="n">write_run_output</span>
    <span class="kn">from</span> <span class="nn">nestcheck.plots</span> <span class="k">import</span> <span class="p">(</span><span class="n">bs_param_dists</span><span class="p">,</span>
                                 <span class="n">param_logx_diagram</span><span class="p">,</span>
                                 <span class="n">weighted_1d_gaussian_kde</span><span class="p">)</span>
    <span class="kn">from</span> <span class="nn">nestcheck.error_analysis</span> <span class="k">import</span> <span class="n">run_ci_bootstrap</span>
    <span class="kn">from</span> <span class="nn">nestcheck.estimators</span> <span class="k">import</span> <span class="n">param_cred</span><span class="p">,</span> <span class="n">logz</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">nestcheck.plots</span> <span class="k">import</span> <span class="n">getdist_kde</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Using native nestcheck KDE instead of GetDist KDE.&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">fgivenx</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot import fgivenx.&#39;</span><span class="p">)</span>

<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">emcee.backends</span> <span class="k">import</span> <span class="n">HDFBackend</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">_verbose</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Cannot import emcee.&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">publication_rc_settings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Serif font with TeX, for papers. &quot;&quot;&quot;</span>
    <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span><span class="s1">&#39;serif&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;serif&#39;</span><span class="p">:[</span><span class="s1">&#39;Computer Modern Roman&#39;</span><span class="p">]})</span>
    <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">slide_rc_settings</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot; Sans-serif font without Tex, for slides. &quot;&quot;&quot;</span>
    <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;family&#39;</span><span class="p">:</span><span class="s1">&#39;sans-serif&#39;</span><span class="p">,</span>
                 <span class="s1">&#39;sans-serif&#39;</span><span class="p">:[</span><span class="s1">&#39;Computer Modern Sans serif&#39;</span><span class="p">]})</span>
    <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">usetex</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">random_seed</span> <span class="o">=</span> <span class="kc">None</span>
<span class="k">def</span> <span class="nf">fix_random_seed</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
    <span class="nd">@wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">random_seed</span>
        <span class="n">state</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">get_state</span><span class="p">()</span>
        <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">random_seed</span><span class="p">)</span>
        <span class="n">_</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">set_state</span><span class="p">(</span><span class="n">state</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">_</span>
    <span class="k">return</span> <span class="n">wrapper</span>

<span class="k">class</span> <span class="nc">AmbiguityError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Thrown if ambiguous sample-set IDs are given when plotting. &quot;&quot;&quot;</span>

<span class="k">class</span> <span class="nc">ParameterError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Thrown if inconsistent parameter names are specified for plotting. &quot;&quot;&quot;</span>

<div class="viewcode-block" id="Run"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Run">[docs]</a><span class="k">class</span> <span class="nc">Run</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Base class for a sample object, containing basic information.</span>

<span class="sd">    :param str ID: For identification of the set of the samples if multiple</span>
<span class="sd">                   sets are jointly plotted.</span>

<span class="sd">    :param str filepath: Path to samples file.</span>

<span class="sd">    :param list names: An ordered list of ``str`` parameter names. The</span>
<span class="sd">                       ordering must match the parameter vector ordering</span>
<span class="sd">                       defined in sample backend objects.</span>

<span class="sd">    :param dict bounds: A dictionary of one-dimensional *hard* parameter</span>
<span class="sd">                        bounds. See :class:`getdist.mcsamples.MCSamples`;</span>
<span class="sd">                        the keys must match the :obj:`names` list. For</span>
<span class="sd">                        the purpose of density estimation plots these</span>
<span class="sd">                        bounds can be viewing bounds.</span>

<span class="sd">    :param list labels: An ordered list of (LaTeX compatible) ``str``</span>
<span class="sd">                        literal parameter labels.</span>

<span class="sd">    :param str implementation: Sampling software applied to generate the</span>
<span class="sd">                               samples. Known options are</span>
<span class="sd">                               ``[&#39;multinest&#39;, &#39;polychord&#39;, &#39;emcee&#39;]``.</span>

<span class="sd">    :param dict truths: Optional dictionary of parameter truths, if *known*;</span>
<span class="sd">                        if *unknown* leave as ``None``. The keys</span>
<span class="sd">                        must be names which match those in</span>
<span class="sd">                        :obj:`names`.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">implementation</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">truths</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">ID</span> <span class="o">=</span> <span class="n">ID</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">samples</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span> <span class="o">=</span> <span class="n">bounds</span>

        <span class="k">if</span> <span class="n">labels</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">labels</span> <span class="o">=</span> <span class="n">labels</span>

        <span class="k">if</span> <span class="n">implementation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">implementation</span> <span class="o">=</span> <span class="n">implementation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_implementation</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">truths</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">truths</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">truths</span> <span class="o">=</span> <span class="n">truths</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_truths</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)))</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ID</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the identification ``str`` of the sample set. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ID</span>

    <span class="nd">@ID</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ID</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the identification ``str`` of the sample set. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid sample set ID specification. &#39;</span>
                            <span class="s1">&#39;See the docstring.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ID</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the parameter names. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span>

    <span class="nd">@names</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the parameter names. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid parameter name specification. See the docstring.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span>  <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the parameter bounds. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>

    <span class="nd">@bounds</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the parameter bounds. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
                <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span> <span class="nb">float</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid parameter bound specification. See the docstring.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span> <span class="o">=</span>  <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the parameter labels. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>

    <span class="nd">@labels</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the parameter labels. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid parameter name specification. See the docstring.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span> <span class="o">=</span>  <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">implementation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Sampling software applied to generate the samples of the run. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_implementation</span>

    <span class="nd">@implementation</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">implementation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the name of the sampling software. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">obj</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;multinest&#39;</span><span class="p">,</span> <span class="s1">&#39;polychord&#39;</span><span class="p">,</span> <span class="s1">&#39;emcee&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_implementation</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Unrecognised software was used to generate the &#39;</span>
                  <span class="s1">&#39;samples of run with ID </span><span class="si">%s</span><span class="s1">. The functionality of this &#39;</span>
                  <span class="s1">&#39;module may be incompatible with the sample information &#39;</span>
                  <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">truths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the parameter truths as a dictionary. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truths</span>

    <span class="nd">@truths</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">truths</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the parameter truths. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">obj</span><span class="p">:</span>
                <span class="nb">float</span><span class="p">(</span><span class="n">obj</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid parameter truth specification. See the docstring.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_truths</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">truth_vector</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the parameter truths as a list. &quot;&quot;&quot;</span>
        <span class="n">v</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
            <span class="n">v</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">truths</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a copy of the samples array. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="nd">@samples</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filepath</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filepath</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_samples</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;File </span><span class="si">%s</span><span class="s1"> does not exist.&#39;</span> <span class="o">%</span> <span class="n">filepath</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the dictionary of line arguments for :mod:`getdist`.</span>

<span class="sd">        :param dict lines: :mod:`getdist`-compatible dictionary of parameters</span>
<span class="sd">                           specifying the properties of the smooth lines</span>
<span class="sd">                           representing one-dimensional marginal distributions</span>
<span class="sd">                           of parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span>

    <span class="nd">@lines</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lines</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid line argument specification. &#39;</span>
                            <span class="s1">&#39;See the docstring.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_lines</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">contours</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the dictionary of contour arguments for :mod:`getdist`.</span>

<span class="sd">        :param dict contours: :mod:`getdist`-compatible dictionary of parameters</span>
<span class="sd">                              specifying the properties of the contours</span>
<span class="sd">                              representing credible regions of the</span>
<span class="sd">                              two-dimensional marginal distributions of</span>
<span class="sd">                              parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_contours</span>

    <span class="nd">@contours</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid contour argument specification. &#39;</span>
                            <span class="s1">&#39;See the docstring.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_contours</span> <span class="o">=</span> <span class="n">obj</span></div>

<div class="viewcode-block" id="NSBackend"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.NSBackend">[docs]</a><span class="k">class</span> <span class="nc">NSBackend</span><span class="p">(</span><span class="n">Run</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Container for nested samples generated by a single run, and backends</span>
<span class="sd">    for analysis of the run.</span>

<span class="sd">    :param dict kde_settings:</span>
<span class="sd">        Settings for instantiation of :class:`getdist.mcsamples.MCSamples`.</span>

<span class="sd">    The other keyword arguments are generic properties passed to the parent</span>
<span class="sd">    class, such as the identification (ID) string of the run.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">root</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">kde_settings</span><span class="p">,</span> <span class="n">use_nestcheck</span><span class="p">,</span>
                 <span class="n">transform</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="n">filerootpath</span> <span class="o">=</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">root</span><span class="p">)</span>
        <span class="n">_filerootpath</span> <span class="o">=</span> <span class="n">filerootpath</span>

        <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">filerootpath</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">)</span>
            <span class="n">ndims</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span>
            <span class="n">temp</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">:])</span>
            <span class="n">ntransform</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">temp</span><span class="p">)</span> <span class="o">-</span> <span class="n">ndims</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filerootpath</span><span class="o">+</span><span class="s1">&#39;_transformed.txt&#39;</span><span class="p">):</span>
                <span class="n">transformed</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                         <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ntransform</span><span class="p">))</span>
                <span class="n">transformed</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,:</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">transformed</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span> <span class="o">=</span> <span class="n">transform</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="mi">2</span><span class="p">:])</span>
                <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filerootpath</span><span class="o">+</span><span class="s1">&#39;_transformed.txt&#39;</span><span class="p">,</span> <span class="n">transformed</span><span class="p">)</span>

            <span class="n">filerootpath</span> <span class="o">+=</span> <span class="s1">&#39;_transformed&#39;</span>
            <span class="n">root</span> <span class="o">+=</span> <span class="s1">&#39;_transformed&#39;</span>

        <span class="nb">super</span><span class="p">(</span><span class="n">NSBackend</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="n">filerootpath</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># getdist backend</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gd_bcknd</span> <span class="o">=</span> <span class="n">getdist</span><span class="o">.</span><span class="n">mcsamples</span><span class="o">.</span><span class="n">MCSamples</span><span class="p">(</span><span class="n">root</span><span class="o">=</span><span class="n">filerootpath</span><span class="p">,</span>
                             <span class="n">settings</span><span class="o">=</span><span class="n">kde_settings</span><span class="p">,</span>
                             <span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;nested&#39;</span><span class="p">,</span>
                             <span class="n">names</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                             <span class="n">ranges</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                             <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gd_bcknd</span><span class="o">.</span><span class="n">readChains</span><span class="p">(</span><span class="n">getdist</span><span class="o">.</span><span class="n">chains</span><span class="o">.</span><span class="n">chainFiles</span><span class="p">(</span><span class="n">filerootpath</span><span class="p">))</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_kde_settings</span> <span class="o">=</span> <span class="n">kde_settings</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">use_nestcheck</span> <span class="o">=</span> <span class="n">use_nestcheck</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_nestcheck</span><span class="p">:</span> <span class="c1"># nestcheck backend</span>
            <span class="k">if</span> <span class="n">transform</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;dead-birth.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;phys_live-birth.txt&#39;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filerootpath</span> <span class="o">+</span> <span class="n">ext</span><span class="p">):</span>
                        <span class="n">samples</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">loadtxt</span><span class="p">(</span><span class="n">_filerootpath</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
                        <span class="n">transformed</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                 <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">ntransform</span><span class="p">))</span>
                        <span class="n">transformed</span><span class="p">[:,</span><span class="n">ndims</span><span class="o">+</span><span class="n">ntransform</span><span class="p">:]</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">ndims</span><span class="p">:]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="n">transformed</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">ndims</span><span class="o">+</span><span class="n">ntransform</span><span class="p">]</span> <span class="o">=</span>\
                                                <span class="n">transform</span><span class="p">(</span><span class="n">samples</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">ndims</span><span class="p">])</span>

                        <span class="n">_np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filerootpath</span> <span class="o">+</span> <span class="n">ext</span><span class="p">,</span> <span class="n">transformed</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">filerootpath</span> <span class="o">+</span> <span class="s1">&#39;.stats&#39;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">_filerootpath</span> <span class="o">+</span> <span class="s1">&#39;.stats&#39;</span><span class="p">):</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="kn">from</span> <span class="nn">shutil</span> <span class="k">import</span> <span class="n">copyfile</span> <span class="k">as</span> <span class="n">_copyfile</span>
                        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">_copyfile</span><span class="p">(</span><span class="n">_filerootpath</span> <span class="o">+</span> <span class="s1">&#39;.stats&#39;</span><span class="p">,</span>
                                      <span class="n">filerootpath</span> <span class="o">+</span> <span class="s1">&#39;.stats&#39;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;implementation&#39;</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Root </span><span class="si">%r</span><span class="s1"> sampling implementation not specified... &#39;</span>
                      <span class="s1">&#39;assuming MultiNest for nestcheck...&#39;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_nc_bcknd</span> <span class="o">=</span> <span class="n">process_multinest_run</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
                                                       <span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;implementation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;multinest&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nc_bcknd</span> <span class="o">=</span> <span class="n">process_multinest_run</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
                                                           <span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;implementation&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;polychord&#39;</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_nc_bcknd</span> <span class="o">=</span> <span class="n">process_polychord_run</span><span class="p">(</span><span class="n">root</span><span class="p">,</span>
                                                           <span class="n">base_dir</span><span class="o">=</span><span class="n">base_dir</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Cannot process with nestcheck.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">getdist_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the :class:`getdist.mcsamples.MCSamples` instance. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gd_bcknd</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">kde_settings</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the input :mod:`getdist` KDE settings dictionary. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_kde_settings</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">nestcheck_backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the :mod:`nestcheck` backend for the nested samples. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_nc_bcknd</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">margeStats</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Return the marginal statistics using :mod:`getdist`. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mcsamples</span><span class="o">.</span><span class="n">getMargeStats</span><span class="p">()</span></div>

<span class="k">class</span> <span class="nc">Params</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Information about parameters shared by runs for plotting. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_names</span> <span class="o">=</span> <span class="n">names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_names</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">idxs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_idxs</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bounds</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_bounds</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">labels</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_labels</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">truths</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_truths</span>

<div class="viewcode-block" id="Runs"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Runs">[docs]</a><span class="k">class</span> <span class="nc">Runs</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Container for nested sampling run objects. &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span><span class="p">):</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="nb">iter</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">runs</span><span class="p">,</span> <span class="n">Run</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="o">=</span> <span class="p">[</span><span class="n">runs</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Run objects must be instances of the ``Run`` &#39;</span>
                                <span class="s1">&#39;class.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">IDs</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="n">runs</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">Run</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Run objects must be instances of the &#39;</span>
                                    <span class="s1">&#39;``Run`` class.&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">IDs</span><span class="p">:</span>
                    <span class="n">IDs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">AmbiguityError</span><span class="p">(</span><span class="s1">&#39;Use distinct IDs for distinct sets &#39;</span>
                                         <span class="s1">&#39;of samples.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="o">=</span> <span class="n">runs</span>

<div class="viewcode-block" id="Runs.load_all"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Runs.load_all">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_all</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">roots</span><span class="p">,</span> <span class="n">IDs</span><span class="p">,</span> <span class="n">use_nestcheck</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct a :class:`Run` instance by loading distinct runs with</span>
<span class="sd">            equivalent arguments. &quot;&quot;&quot;</span>

        <span class="n">runs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">use_nestcheck</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">roots</span><span class="p">,</span> <span class="n">IDs</span><span class="p">,</span> <span class="n">use_nestcheck</span><span class="p">):</span>
            <span class="n">runs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">NSBackend</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">ID</span><span class="o">=</span><span class="n">ID</span><span class="p">,</span>
                                  <span class="n">use_nestcheck</span><span class="o">=</span><span class="n">use_nestcheck</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">runs</span><span class="p">)</span></div>

<div class="viewcode-block" id="Runs.set_subset"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Runs.set_subset">[docs]</a>    <span class="k">def</span> <span class="nf">set_subset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IDs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">combine_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">force_combine</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set a current list of :class:`Run` instances.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">IDs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="n">IDs</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span> <span class="o">==</span> <span class="n">ID</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">run</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">force_combine</span><span class="p">:</span> <span class="c1"># create new run object</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">(</span><span class="n">combine_all</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">combine</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;_combined&#39;</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_combine</span><span class="p">(</span><span class="n">combine_all</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_combined</span> <span class="o">=</span> <span class="kc">None</span></div>

    <span class="k">def</span> <span class="nf">_combine</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">combine_all</span><span class="p">:</span>
            <span class="n">str_IDs</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span>
                                                    <span class="n">current</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">str_IDs</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span>
                                                    <span class="n">current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">use_nestcheck</span><span class="p">:</span>
                <span class="k">break</span>

        <span class="n">base_dir</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span>
        <span class="n">file_root</span> <span class="o">=</span> <span class="s1">&#39;combined_IDs_</span><span class="si">%s</span><span class="s1">_&#39;</span> <span class="o">%</span> <span class="n">str_IDs</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span> <span class="n">file_root</span><span class="o">+</span><span class="s1">&#39;.txt&#39;</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">combine_all</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">combine_ns_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;nestcheck_backend&#39;</span><span class="p">,</span>
                                                    <span class="n">current</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                    <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">run</span> <span class="o">=</span> <span class="n">combine_ns_runs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;nestcheck_backend&#39;</span><span class="p">,</span>
                                                    <span class="n">current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                    <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>

            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;base_dir&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_dir</span>
            <span class="n">run</span><span class="p">[</span><span class="s1">&#39;output&#39;</span><span class="p">][</span><span class="s1">&#39;file_root&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">file_root</span>

            <span class="n">write_run_output</span><span class="p">(</span><span class="n">run</span><span class="p">,</span>
                             <span class="n">write_dead</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">write_stats</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">posteriors</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">stats_means_errs</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                             <span class="n">n_simulate</span> <span class="o">=</span> <span class="mi">1000</span><span class="p">)</span>

        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;kde_settings&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">kde_settings</span><span class="p">,</span>
                  <span class="s1">&#39;ID&#39;</span><span class="p">:</span> <span class="s1">&#39;combined&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;implementation&#39;</span><span class="p">:</span> <span class="s1">&#39;polychord&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;names&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                  <span class="s1">&#39;bounds&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                  <span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                  <span class="s1">&#39;truths&#39;</span><span class="p">:</span> <span class="n">_</span><span class="o">.</span><span class="n">truths</span><span class="p">}</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_combined</span> <span class="o">=</span> <span class="n">NSBackend</span><span class="p">(</span><span class="n">file_root</span><span class="p">,</span>
                                   <span class="n">base_dir</span> <span class="o">=</span> <span class="n">base_dir</span><span class="p">,</span>
                                   <span class="n">use_nestcheck</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                                   <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">subset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the current subset of runs and parameters for plotting. &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span>

    <span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a :class:`Run` instance using the associated ID. &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ID</span> <span class="o">==</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">run</span>

        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s1">&#39;No run with ID matching key.&#39;</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">combined</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Try to get a combined run in the form of a :mod:`nestcheck`</span>
<span class="sd">            backend. &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combined</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;No combined run available. Set the run-subset and combine.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_combined</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;You must combine runs.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="Runs.get_attr"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Runs.get_attr">[docs]</a>    <span class="k">def</span> <span class="nf">get_attr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attribute</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a list of attributes of the :class:`Run` instances stored as</span>
<span class="sd">            the current subset. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">nestcheck_compatible</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> \
                 <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subset</span> <span class="k">if</span> <span class="n">current</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">)</span> <span class="k">if</span> <span class="n">run</span><span class="o">.</span><span class="n">use_nestcheck</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">[</span><span class="nb">getattr</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attribute</span><span class="p">)</span> <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> \
                                     <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subset</span> <span class="k">if</span> <span class="n">current</span> <span class="k">else</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">)]</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the current parameter information. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span>

<div class="viewcode-block" id="Runs.set_params"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.Runs.set_params">[docs]</a>    <span class="k">def</span> <span class="nf">set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">names</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set current parameters for plotting which are shared. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_idxs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">names</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">names</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">param</span> <span class="o">==</span> <span class="n">name</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">k</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">!=</span> <span class="n">k</span><span class="p">:</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="kc">None</span>
                            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">%s</span><span class="s1"> index not uniform &#39;</span>
                                             <span class="s1">&#39;across runs.&#39;</span> <span class="o">%</span>
                                             <span class="p">(</span><span class="n">param</span><span class="p">,</span>
                                              <span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>
                                              <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>
                        <span class="k">break</span>
                    <span class="k">elif</span> <span class="n">k</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">names</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="kc">None</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;No parameter name matching </span><span class="si">%s</span><span class="s1"> in run &#39;</span>
                                         <span class="s1">&#39;with ID </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">param</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="s1">&#39;bounds&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="s1">&#39;labels&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_params</span><span class="p">(</span><span class="s1">&#39;truths&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_params</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">raise</span></div>

    <span class="k">def</span> <span class="nf">_set_params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attrs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check consistency of a parameter across runs. &quot;&quot;&quot;</span>

        <span class="n">_attrs</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">attrs</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="n">_attrs</span><span class="p">,</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_names</span><span class="p">))</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">param</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="o">.</span><span class="n">_names</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attrs</span><span class="p">)[</span><span class="n">param</span><span class="p">]</span> \
                            <span class="o">!=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">attrs</span><span class="p">)[</span><span class="n">param</span><span class="p">]):</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Inconsistent </span><span class="si">%s</span><span class="s1"> for parameter&#39;</span>
                                         <span class="s1">&#39; </span><span class="si">%s</span><span class="s1"> between runs </span><span class="si">%s</span><span class="s1"> and </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
                                         <span class="p">(</span><span class="n">attrs</span><span class="p">,</span> <span class="n">param</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">))</span>
                <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_params</span><span class="p">,</span> <span class="n">_attrs</span><span class="p">)[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> \
                        <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_subset</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">attrs</span><span class="p">)[</span><span class="n">param</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Parameter </span><span class="si">%s</span><span class="s1"> not specified correctly.&#39;</span> <span class="o">%</span> <span class="n">attrs</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="PostProcessor"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.PostProcessor">[docs]</a><span class="k">class</span> <span class="nc">PostProcessor</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Post-process samples for inference and posterior checking.</span>

<span class="sd">    Calculate inferences, usually in the form of approximate integrals over</span>
<span class="sd">    the posterior distribution. Also visualise posterior information and</span>
<span class="sd">    derived quantities.</span>

<span class="sd">    Perform posterior predictive checking.</span>

<span class="sd">    :param runs: An instance of :class:`Runs` or an instance of :class:`Run`.</span>

<span class="sd">    :param likelihood: The instance of :class:`~.Likelihood` used for</span>
<span class="sd">                       sampling, or a clone of that instance. Defaults to</span>
<span class="sd">                       ``None``. If multiple likelihood functions are</span>
<span class="sd">                       associated with the runs due to discreteness in the</span>
<span class="sd">                       model space, one can pass a dictionary with keys</span>
<span class="sd">                       matching the IDs of the runs.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">runs</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">likelihood</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">runs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">runs</span> <span class="o">=</span> <span class="n">runs</span>

        <span class="k">if</span> <span class="n">likelihood</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span> <span class="o">=</span> <span class="n">likelihood</span>

<div class="viewcode-block" id="PostProcessor.load_runs"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.PostProcessor.load_runs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">load_runs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span>
                  <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                  <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Construct :class:`Runs` instance and then :class:`PostProcessor`</span>
<span class="sd">        instance.</span>

<span class="sd">        :param `*args`: Passed directly to :meth:`Runs.load_all`.</span>

<span class="sd">        :param `**kwargs`:</span>
<span class="sd">            Passed directly to :meth:`Runs.load_all`. Also a ``&#39;likelihood&#39;``</span>
<span class="sd">            argument can be handled for ``__init__``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">likelihood</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;likelihood&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="bp">cls</span><span class="p">(</span><span class="n">Runs</span><span class="o">.</span><span class="n">load_all</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">),</span> <span class="n">likelihood</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">runs</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the nested sampling runs. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span>

    <span class="nd">@runs</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">runs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the nested sampling runs object. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Runs</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Run</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span> <span class="o">=</span> <span class="n">Runs</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;An instance of :class:`Runs` must be &#39;</span>
                                <span class="s1">&#39;supplied.&#39;</span><span class="p">)</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the likelihood instance. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@likelihood</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">likelihood</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span> <span class="c1"># make dictionary possible</span>
        <span class="sd">&quot;&quot;&quot; Set the likelihood object. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Likelihood</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
             <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;The likelihood object needs to derive from &#39;</span>
                             <span class="s1">&#39;xpsi.Likelihood.Likelihood.&#39;</span><span class="p">)</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Curating set of runs for posterior plotting&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Run set curated&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_set_runs_to_plot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">IDs</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Helper function to get and notify which runs will be plotted. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">IDs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">IDs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">,</span> <span class="n">current</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">5</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">combine</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">set_subset</span><span class="p">(</span><span class="n">IDs</span><span class="p">[:</span><span class="mi">5</span><span class="p">],</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Only the first five positional runs will be &#39;</span>
                  <span class="s1">&#39;plotted individually, with IDs&#39;</span>
                  <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">)))</span>

        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">IDs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">5</span> <span class="ow">and</span> <span class="n">combine</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">set_subset</span><span class="p">(</span><span class="n">IDs</span><span class="p">[:</span><span class="mi">4</span><span class="p">],</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: Only the first four positional runs will be &#39;</span>
                  <span class="s1">&#39;plotted individually, with IDs &#39;</span>
                  <span class="o">+</span> <span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span> <span class="k">for</span> <span class="n">ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">set_subset</span><span class="p">(</span><span class="n">IDs</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_set_line_and_contour_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Match the :mod:`nestcheck` color scheme.</span>

<span class="sd">        Always assigns reds to a combined run if it is found to exist.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">nestcheck_colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;darkred&#39;</span><span class="p">,</span> <span class="s1">&#39;darkblue&#39;</span><span class="p">,</span> <span class="s1">&#39;darkgrey&#39;</span><span class="p">,</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">,</span>
                            <span class="s1">&#39;darkorange&#39;</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lw_1d&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="p">),</span>
                                          <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
                                          <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">contours</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="n">lw</span><span class="p">,</span>
                                            <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="s1">&#39;darkred&#39;</span><span class="p">,</span>
                                            <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">i</span><span class="o">=</span><span class="mi">1</span>

        <span class="k">for</span> <span class="n">run</span><span class="p">,</span> <span class="n">color</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">,</span>
                              <span class="n">nestcheck_colors</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">)]):</span>
            <span class="n">run</span><span class="o">.</span><span class="n">lines</span> <span class="o">=</span>  <span class="p">{</span><span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lw_1d&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="p">),</span>
                          <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span>
                          <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>
            <span class="n">run</span><span class="o">.</span><span class="n">contours</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;lw&#39;</span><span class="p">:</span> <span class="n">lw</span><span class="p">,</span> <span class="s1">&#39;color&#39;</span><span class="p">:</span> <span class="n">color</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span> <span class="n">alpha</span><span class="p">}</span>

<div class="viewcode-block" id="PostProcessor.plot_posteriorDensity"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.PostProcessor.plot_posteriorDensity">[docs]</a>    <span class="nd">@fix_random_seed</span>
    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Executing posterior density estimation&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Posterior density estimation complete&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot_posteriorDensity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span>
                               <span class="n">run_IDs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                               <span class="n">combine</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">combine_all</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">only_combined</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">bootstrap_estimators</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                               <span class="n">bootstrap_density</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">separate_plots</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">write</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                               <span class="n">root_filename</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>
                               <span class="n">directory</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                               <span class="n">ext</span><span class="o">=</span><span class="s1">&#39;.pdf&#39;</span><span class="p">,</span>
                               <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                               <span class="n">maxdots</span><span class="o">=</span><span class="mi">2000</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate posterior density plots with :mod:`getdist` and :mod:`nestcheck` for</span>
<span class="sd">        nested sampling runs.</span>

<span class="sd">        Up to five runs can be plotted natively via :mod:`nestcheck`; beyond</span>
<span class="sd">        such a number the plots are generally display too much information and</span>
<span class="sd">        clarity is lost.</span>

<span class="sd">        :param list params:</span>
<span class="sd">            List of parameter strings for plotting. Must match</span>
<span class="sd">            identifier strings which are attributes of :class:`Run`</span>
<span class="sd">            instances, and those parameters must occupy the same</span>
<span class="sd">            indices across the :class:`Run` instances (a limitation,</span>
<span class="sd">            but the :mod:`nestcheck` package assumes a set of realisations</span>
<span class="sd">            of the same nested sampling process).</span>

<span class="sd">        :param list run_IDs:</span>
<span class="sd">            An iterable containing string identifiers of instances</span>
<span class="sd">            of :class:`Run` instances. These identifiers must</span>
<span class="sd">            match objects collected in the :class:`Runs` instance</span>
<span class="sd">            stored as an attribute of an instance of the</span>
<span class="sd">            :class:`PostProcessing` class. Defaults to ``None``,</span>
<span class="sd">            meaning attempt to use all runs in the attribute</span>
<span class="sd">            instance of :class:`Runs`.</span>

<span class="sd">        :param bool combine:</span>
<span class="sd">            Additionally combine the runs into a single run for overplotting?</span>

<span class="sd">        :param bool combine_all:</span>
<span class="sd">            Combine all runs in the :class:`Runs` instance or only those</span>
<span class="sd">            for which IDs are provided? Ignored if ``combine`` is ``False``.</span>

<span class="sd">        :param bool only_combine:</span>
<span class="sd">            Only plot the combined run? Ignored if ``combine`` is ``False``.</span>

<span class="sd">        :param bool bootstrap:</span>
<span class="sd">            Use :mod:`nestcheck` and :mod:`fgivenx` to bootstrap the runs for</span>
<span class="sd">            posterior density error estimation?</span>

<span class="sd">        :param bool separate_plots:</span>
<span class="sd">            Generate a lower-triangle plot with :mod:`getdist`, and a separate</span>
<span class="sd">            error plot with :mod:`nestcheck` (with :mod:`fgivenx` and</span>
<span class="sd">            :mod:`getdist`). If ``False`` (default), the diagonal panels of the</span>
<span class="sd">            lower-triangle plot are modified by adding the nestcheck output.</span>
<span class="sd">            Ignored if ``bootstrap`` is ``False``.</span>

<span class="sd">        :param bool write: Export the figure?</span>

<span class="sd">        :param str root_filename:</span>
<span class="sd">            Root filename to prepend to automatically generated name. Can be,</span>
<span class="sd">            e.g., a model and/or data set identifier.</span>

<span class="sd">        :param str directory: If ``None`` defaults to current directory.</span>

<span class="sd">        :param str ext: File extension for writing. E.g., ``&#39;.png&#39;``.</span>

<span class="sd">        :param int dpi: Dots-per-square-inch settings for exporting plots.</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">            Keyword arguments for the :meth:`_plot_density_with_error` and</span>
<span class="sd">            :meth:`_plot_triangle` methods. Keyword arguments for line</span>
<span class="sd">            properties (width and alpha) for :mod:`getdist` contours and density</span>
<span class="sd">            distributions. If ``bootstrap and not separate_plots`` then</span>
<span class="sd">            the density distribution linewidth is set to zero if not</span>
<span class="sd">            explicitly specified with kward ``lw_1d``.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_runs_to_plot</span><span class="p">(</span><span class="n">run_IDs</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">set_params</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bootstrap_density</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">separate_plots</span><span class="p">:</span>
            <span class="k">if</span> <span class="s1">&#39;lw_1d&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;lw_1d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_set_line_and_contour_args</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_triangle</span><span class="p">(</span><span class="n">only_combined</span><span class="p">,</span>
                                      <span class="n">bootstrap_estimators</span><span class="p">,</span>
                                      <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bootstrap_density</span> <span class="ow">and</span> <span class="n">separate_plots</span><span class="p">:</span>
            <span class="n">figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_density_with_error</span><span class="p">(</span><span class="n">only_combined</span><span class="o">=</span><span class="n">only_combined</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">bootstrap_density</span><span class="p">:</span>
            <span class="n">figs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plot_density_with_error</span><span class="p">(</span><span class="n">plotter</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span><span class="p">,</span>
                                                 <span class="n">only_combined</span><span class="o">=</span><span class="n">only_combined</span><span class="p">,</span>
                                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
            <span class="n">root_filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">root_filename</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span> <span class="k">if</span> <span class="n">root_filename</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> \
                <span class="s1">&#39;posteriorDensity__runs_&#39;</span> <span class="o">+</span> \
                <span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span>
                         <span class="n">ID</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span>


            <span class="n">_dpi</span> <span class="o">=</span> <span class="n">dpi</span>
            <span class="k">if</span> <span class="n">maxdots</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ndots</span> <span class="o">=</span> <span class="n">dpi</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">)</span>
                <span class="n">ndots</span> <span class="o">*=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">subplot_size_inch</span>
                <span class="k">if</span> <span class="n">ndots</span> <span class="o">&gt;</span> <span class="n">maxdots</span><span class="p">:</span>
                    <span class="n">dpi</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">maxdots</span> <span class="o">*</span> <span class="n">_dpi</span> <span class="o">/</span> <span class="n">ndots</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span><span class="o">.</span><span class="n">export</span><span class="p">(</span><span class="n">fname</span><span class="o">=</span><span class="n">root_filename</span><span class="o">+</span><span class="s1">&#39;triangle&#39;</span><span class="o">+</span><span class="n">ext</span><span class="p">,</span>
                                   <span class="n">adir</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">figs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span>
                                              <span class="n">root_filename</span><span class="o">+</span><span class="s1">&#39;fthetas_1d.pdf&#39;</span><span class="p">),</span>
                                <span class="n">dpi</span><span class="o">=</span><span class="n">_dpi</span><span class="p">,</span>
                                <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">separate_plots</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">root_filename</span> <span class="o">+</span> <span class="s1">&#39;params_1d.pdf&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">fname</span> <span class="o">=</span> <span class="n">root_filename</span> <span class="o">+</span> <span class="s1">&#39;fthetas_1d.pdf&#39;</span>
                <span class="n">figs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">fname</span><span class="p">),</span>
                                <span class="n">dpi</span><span class="o">=</span><span class="n">_dpi</span><span class="p">,</span>
                                <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">NameError</span><span class="p">):</span>
                <span class="k">pass</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span></div>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Simulating nested sampling realisations for &#39;</span>
                  <span class="s1">&#39;posterior density error visualisation&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Simulated nested sampling realisations and &#39;</span>
                  <span class="s1">&#39;plotted posterior density error estimates&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_plot_density_with_error</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                 <span class="n">only_combined</span><span class="p">,</span>
                                 <span class="n">plotter</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">fthetas</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">kde_func</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="n">kde_settings</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        :param bool only_combined:</span>
<span class="sd">            Only plot the combination of all runs?</span>

<span class="sd">        :param plotter:</span>
<span class="sd">            A :attr:`getdist.GetDistPlotter` instance if the :mod:`nestcheck`</span>
<span class="sd">            output is to be displayed on a lower-triangle plot. Assumes the</span>
<span class="sd">            parameter order for the ``GetDistPlotter`` is equal to the order</span>
<span class="sd">            of parameters in the ``Runs`` instance.</span>

<span class="sd">        :param list fthetas:</span>
<span class="sd">            Iterable containing functions of parameter vector for which</span>
<span class="sd">            density is to be plotted with :mod:`nestcheck` via :mod:`fgivenx`.</span>
<span class="sd">            The parameters themselves are handled automatically with ``lambda``</span>
<span class="sd">            functions. Additional functions are always plotted using the</span>
<span class="sd">            native :mod:`nestcheck` matplotlib figure; the parameter densities</span>
<span class="sd">            are be added to a :mod:`getdist` lower-triangle plot is supplied.</span>

<span class="sd">        :param func kde_func:</span>
<span class="sd">            Function for KDE compatible with :mod:`nestcheck.plots`. Must</span>
<span class="sd">            be *weighted* KDE (Higson et al. 2018). If ``None``, uses</span>
<span class="sd">            :mod:`getdist` if available, or the native KDE function otherwise. If</span>
<span class="sd">            using :mod:`getdist`, the KDE settings are automatically retrieved from</span>
<span class="sd">            the first run and applied to :mod:`nestcheck` and :mod:`fgivenx`</span>
<span class="sd">            *for all runs*.</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">            Keyword arguments for :func:`nestcheck.plots.bs_param_dists`.</span>

<span class="sd">        TODO:</span>
<span class="sd">        ----</span>

<span class="sd">            * lims based on credible interval estimate for efficiency?</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">NSBackend</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Nested sampling backends are required.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nested sampling runs are required.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">only_combined</span><span class="p">:</span>
                <span class="n">nestcheck_bcknds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">nestcheck_backend</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ensure combined run plotted on top with nestcheck</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">nestcheck_bcknds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">nestcheck_bcknds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;nestcheck_backend&#39;</span><span class="p">,</span>
                                                           <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">nestcheck_bcknds</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;nestcheck_backend&#39;</span><span class="p">,</span>
                                                            <span class="n">nestcheck_compatible</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">nx</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;nx&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">);</span> <span class="n">ny</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ny&#39;</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
        <span class="n">scale_ymax</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;scale_ymax&#39;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="n">n_simulate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;n_simulate&#39;</span><span class="p">,</span> <span class="mi">200</span><span class="p">)</span>

        <span class="n">params</span><span class="p">,</span> <span class="n">idxs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">idxs</span>
        <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">labels</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bounds</span>

        <span class="n">lims</span> <span class="o">=</span> <span class="p">[</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">))]</span>
        <span class="k">for</span> <span class="n">l</span><span class="p">,</span> <span class="n">b</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">lims</span><span class="p">,</span> <span class="n">bounds</span><span class="p">):</span>
            <span class="n">l</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
            <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">else</span> <span class="n">b</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">l</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">else</span> <span class="n">b</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">kde_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">kde_func</span> <span class="o">=</span> <span class="n">getdist_kde</span>
            <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
                <span class="n">kde_func</span> <span class="o">=</span> <span class="n">weighted_1d_gaussian_kde</span>
                <span class="n">kde_kwargs</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">kde_settings</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">kde_settings</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">kde_settings</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;kde_settings&#39;</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">kde_settings</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;kde_settings&#39;</span><span class="p">)</span>
                <span class="n">kde_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;settings&#39;</span><span class="p">:</span> <span class="n">kde_settings</span><span class="p">,</span>
                              <span class="s1">&#39;ranges&#39;</span><span class="p">:</span> <span class="n">bounds</span><span class="p">,</span>
                              <span class="s1">&#39;normalize&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;normalize&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)}</span>

        <span class="n">lines</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="n">parallel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;parallel&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">rasterize_contours</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;rasterize_contours&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">tqdm_kwargs</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;tqdm_kwargs&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">figsize</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;figsize&#39;</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">6.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">),</span>
                                                   <span class="mf">3.0</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)]))</span>

        <span class="n">figs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="n">plotter</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">,</span>
                     <span class="s1">&#39;Adding density error information to triangle plot&#39;</span><span class="p">,</span>
                     <span class="s1">&#39;Added density error information&#39;</span><span class="p">):</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="n">nestcheck</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">bs_param_dists</span><span class="p">(</span><span class="n">nestcheck_bcknds</span><span class="p">,</span>
                <span class="n">fthetas</span><span class="o">=</span><span class="p">[(</span><span class="k">lambda</span> <span class="n">y</span><span class="p">:</span> <span class="p">(</span><span class="k">lambda</span> <span class="n">theta</span><span class="p">:</span> <span class="n">theta</span><span class="p">[:,</span><span class="n">y</span><span class="p">]))(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">idxs</span><span class="p">],</span>
                <span class="n">kde_func</span><span class="o">=</span><span class="n">kde_func</span><span class="p">,</span>
                <span class="n">kde_kwargs</span><span class="o">=</span><span class="n">kde_kwargs</span><span class="p">,</span>
                <span class="n">ftheta_lims</span><span class="o">=</span><span class="n">lims</span><span class="p">,</span>
                <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span>
                <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
                <span class="n">scale_ymax</span><span class="o">=</span><span class="n">scale_ymax</span><span class="p">,</span>
                <span class="n">n_simulate</span><span class="o">=</span><span class="n">n_simulate</span><span class="p">,</span>
                <span class="n">simulate_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">getdist_plotter</span><span class="o">=</span><span class="n">plotter</span><span class="p">,</span>
                <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                <span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span>
                <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
                <span class="n">rasterize_contours</span><span class="o">=</span><span class="n">rasterize_contours</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span>
                <span class="n">no_means</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">tqdm_kwargs</span><span class="o">=</span><span class="n">tqdm_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fig</span><span class="p">:</span> <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">fthetas</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">iter</span><span class="p">(</span><span class="n">fthetas</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">fthetas</span> <span class="o">=</span> <span class="p">[</span><span class="n">fthetas</span><span class="p">]</span>
            <span class="n">ftheta_lims</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;ftheta_lims&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">ftheta_lims</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Supply ftheta limits.&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kde_kwargs</span><span class="p">[</span><span class="s1">&#39;ranges&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ftheta_lims</span>
            <span class="n">figsize</span> <span class="o">*=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">fthetas</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="k">if</span> <span class="s1">&#39;ftheta_labels&#39;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;labels&#39;</span><span class="p">:</span> <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;ftheta_labels&#39;</span><span class="p">]}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="n">fig</span> <span class="o">=</span> <span class="n">nestcheck</span><span class="o">.</span><span class="n">plots</span><span class="o">.</span><span class="n">bs_param_dists</span><span class="p">(</span><span class="n">nestcheck_bcknds</span><span class="p">,</span>
                                        <span class="n">fthetas</span><span class="o">=</span><span class="n">fthetas</span><span class="p">,</span>
                                        <span class="n">kde_func</span><span class="o">=</span><span class="n">kde_func</span><span class="p">,</span>
                                        <span class="n">kde_kwargs</span><span class="o">=</span><span class="n">kde_kwargs</span><span class="p">,</span>
                                        <span class="n">ftheta_lims</span><span class="o">=</span><span class="n">ftheta_lims</span><span class="p">,</span>
                                        <span class="n">nx</span><span class="o">=</span><span class="n">nx</span><span class="p">,</span>
                                        <span class="n">ny</span><span class="o">=</span><span class="n">ny</span><span class="p">,</span>
                                        <span class="n">scale_ymax</span><span class="o">=</span><span class="n">scale_ymax</span><span class="p">,</span>
                                        <span class="n">n_simulate</span><span class="o">=</span><span class="n">n_simulate</span><span class="p">,</span>
                                        <span class="n">simulate_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">figsize</span><span class="o">=</span><span class="n">figsize</span><span class="p">,</span>
                                        <span class="n">lines</span><span class="o">=</span><span class="n">lines</span><span class="p">,</span>
                                        <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
                                        <span class="n">rasterize_contours</span><span class="o">=</span><span class="n">rasterize_contours</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">figs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">fig</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">figs</span> <span class="k">if</span> <span class="n">figs</span> <span class="k">else</span> <span class="kc">None</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Constructing lower-triangle posterior density &#39;</span>
                  <span class="s1">&#39;plot via Gaussian KDE:&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Constructed lower-triangle posterior density plot&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_plot_triangle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">only_combined</span><span class="p">,</span>
                       <span class="n">bootstrap</span><span class="p">,</span>
                       <span class="n">prior_density</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">KL_divergence</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">KL_base</span> <span class="o">=</span> <span class="s1">&#39;bits&#39;</span><span class="p">,</span>
                       <span class="n">ndraws</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">1e6</span><span class="p">),</span>
                       <span class="n">param_plot_lims</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">crosshairs</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">filled</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">legend_loc</span> <span class="o">=</span> <span class="s1">&#39;lower left&#39;</span><span class="p">,</span>
                       <span class="n">legend_corner_coords</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.75</span><span class="p">,</span><span class="mf">0.75</span><span class="p">),</span>
                       <span class="n">legend_frameon</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">scale_attrs</span> <span class="o">=</span> <span class="p">{},</span>
                       <span class="n">normalize</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">veneer</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">no_zero</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">no_ylabel</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">label_right</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">no_ytick</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">credible_interval_1d</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">ID_for_1D_estimators</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                       <span class="n">annotate_credible_interval</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">annotate_xy</span><span class="o">=</span><span class="p">(</span><span class="mf">0.025</span><span class="p">,</span><span class="mf">0.915</span><span class="p">),</span>
                       <span class="n">sixtyeight</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
                       <span class="n">ninety</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
                       <span class="n">compute_all_intervals</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Call :meth:`getdist.plots.GetDistPlotter.triangle_plot`.</span>

<span class="sd">        :param bool only_combined:</span>
<span class="sd">            Plot only the combined run?</span>

<span class="sd">        :param bool prior_density:</span>
<span class="sd">            If ``True`` tries to draw samples from the joint prior and plot</span>
<span class="sd">            marginal 1D prior densit functions. Silently fails if attempt</span>
<span class="sd">            fails due to missing likelihood and prior callables.</span>

<span class="sd">        :param bool KL_divergence:</span>
<span class="sd">            If `True` and `prior_density` is `True`, estimate and annotate</span>
<span class="sd">            credible interval for Kullback-Leibler divergence for each</span>
<span class="sd">            parameter in triangle plot.</span>

<span class="sd">        :param str KL_base:</span>
<span class="sd">            Base for Kullback-Leibler divergence. Options are {&#39;bits&#39;, &#39;nats&#39;}.</span>

<span class="sd">        :param int ndraws:</span>
<span class="sd">            Number of samples drawn from the joint prior. Ignored if</span>
<span class="sd">            ``prior_density is False`` attempt to plot density fails.</span>

<span class="sd">        :param dict param_plot_lims:</span>
<span class="sd">            Dictionary of viewing ranges for plotting. Keys must be parameter</span>
<span class="sd">            names.</span>

<span class="sd">        :param bool crosshairs: Display parameter truth crosshairs?</span>

<span class="sd">        :param bool filled: Specify whether the contours are to be filled.</span>

<span class="sd">        :param str legend_loc: Specify the legend location. Defaults to</span>
<span class="sd">                               ``upper right`` because the plot is a lower-</span>
<span class="sd">                               triangle array.</span>

<span class="sd">        :param tuple legend_corner_coords:</span>
<span class="sd">            Modifies meaning of ``legend_loc`` to be the coordinates of the</span>
<span class="sd">            point on the legend box specified by ``legend_loc``. Pass ``None``</span>
<span class="sd">            if not applicable. Defaults to place legend in empty upper region</span>
<span class="sd">            of lower-triangle plot.</span>

<span class="sd">        :param dict scale_attrs:</span>
<span class="sd">            Scale :class:`getdist.plots.GetDistPlotterSettings` attributes</span>
<span class="sd">            from the automatic values. E.g., ``{&#39;legend_fontsize&#39;: 2.0}``.</span>
<span class="sd">            Use string values to set the key attribute to the value attribute.</span>
<span class="sd">            Caution: do not rely on ordering of pairs in the dictionary.</span>

<span class="sd">        :param bool normalize:</span>
<span class="sd">            Normalize density distribution in on-diagonal 1D panels?</span>

<span class="sd">        :param bool no_zero:</span>
<span class="sd">            Hide axes zeros within on-diagonal 1D panels?</span>

<span class="sd">        :param bool no_ylabel:</span>
<span class="sd">            Hide *probability density* label on diagonal 1D marginal panels?</span>

<span class="sd">        :param bool label_right:</span>
<span class="sd">            Display *probability density* label on diagonal 1D marginal plots?</span>

<span class="sd">        :param bool no_ytick:</span>
<span class="sd">            Hide y-axis ticks on diagonal 1D marginal plots?</span>

<span class="sd">        :param bool credible_interval_1d:</span>
<span class="sd">            Estimate and plot 1D marginal credible intervals? The upper</span>
<span class="sd">            and lower quantiles of the interval are estimated via bootstrapping</span>
<span class="sd">            with :mod:`nestcheck`, each bounding quantile plotted as a (narrow)</span>
<span class="sd">            band bounded by the same quantiles with respect to the bootstrap</span>
<span class="sd">            realisations. The interval between the two bands is generally much</span>
<span class="sd">            wider and is shaded lighter.</span>

<span class="sd">        :param str ID_for_1D_estimators:</span>
<span class="sd">            To avoid displaying too much information and resultant plot</span>
<span class="sd">            confusion, only one credible interval is displayed per</span>
<span class="sd">            on-diagonal plot. If a combined run is found to exist, the</span>
<span class="sd">            credible intervals are computed for that combined run; otherwise</span>
<span class="sd">            a run ID string needs to be passed using this argument.</span>

<span class="sd">        :param bool annotate_credible_interval:</span>
<span class="sd">            Annotate each on-diagonal panel with numeric credible interval</span>
<span class="sd">            as median +/- distance to symmetric quantiles. Each quantile,</span>
<span class="sd">            including the median, is estimated via bootstrapping with</span>
<span class="sd">            :mod:`nestcheck`, and the median of each quantile from the bootstrap</span>
<span class="sd">            realisations is used for the reported numeric credible interval.</span>

<span class="sd">        :param tuple annotate_xy:</span>
<span class="sd">            Coordinates as axis fractions for annotation of credible intervals.</span>

<span class="sd">        :param bool sixtyeight:</span>
<span class="sd">            Should the credible interval, which is symmetric in quantiles about</span>
<span class="sd">            the mean, be approximately the 1-\sigma credible interval thus</span>
<span class="sd">            containing ~68% of the posterior mass? If ``False`` the interval</span>
<span class="sd">            computed is the approximate 2-\sigma interval containing ~95% of</span>
<span class="sd">            the posterior mass.</span>

<span class="sd">        :param kwargs:</span>

<span class="sd">            * additional keyword arguments passed to</span>
<span class="sd">              :meth:`getdist.GetDistPlotter.triangle_plot`</span>
<span class="sd">            * settings for :mod:`getdist` posterior lower-triangle plotting, applied</span>
<span class="sd">              to a :class:`getdist.plots.GetDistPlotSettings` instance</span>

<span class="sd">        .. note::</span>
<span class="sd">            Using `subplot_size` keyword argument (specify in inches) invokes</span>
<span class="sd">            automated labelling fontsizes and tick sizes. If `width_inch` is</span>
<span class="sd">            used instead </span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">run</span><span class="p">,</span> <span class="n">NSBackend</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Nested sampling backends are required.&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Nested sampling runs are required.&#39;</span><span class="p">)</span>
            <span class="k">raise</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">only_combined</span><span class="p">:</span>
                <span class="n">getdist_bcknds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">getdist_backend</span>
                <span class="n">legend_labels</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="n">line_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">lines</span>
                <span class="n">contour_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">contours</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># ensure combined run plotted on top with nestcheck</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">getdist_bcknds</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">getdist_backend</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="n">getdist_bcknds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;getdist_backend&#39;</span><span class="p">)</span>

                    <span class="n">legend_labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span>
                    <span class="n">line_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">)</span>
                    <span class="n">contour_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;contours&#39;</span><span class="p">)</span>

                    <span class="n">getdist_bcknds</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">legend_labels</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">line_args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">contour_args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="n">getdist_bcknds</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;getdist_backend&#39;</span><span class="p">)</span>

                    <span class="n">legend_labels</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span>
                    <span class="n">legend_labels</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;ID&#39;</span><span class="p">)</span>
                    <span class="n">line_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">lines</span><span class="p">]</span>
                    <span class="n">line_args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;lines&#39;</span><span class="p">)</span>
                    <span class="n">contour_args</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">contours</span><span class="p">]</span>
                    <span class="n">contour_args</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">get_attr</span><span class="p">(</span><span class="s1">&#39;contours&#39;</span><span class="p">)</span>

                    <span class="n">getdist_bcknds</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">legend_labels</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">line_args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>
                    <span class="n">contour_args</span><span class="o">.</span><span class="n">reverse</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">param_plot_lims</span><span class="p">:</span>
            <span class="n">prune</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;tick_prune&#39;</span><span class="p">)</span>

        <span class="c1"># try to set matching :class:`getdist.plots.GetDistPlotSettings` attrs</span>
        <span class="n">plotter</span> <span class="o">=</span> <span class="n">plots</span><span class="o">.</span><span class="n">getSubplotPlotter</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;subplot_size&#39;</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
                                          <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;width_inch&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;progress&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;norm_prob_label&#39;</span><span class="p">,</span> <span class="s1">&#39;Probability density&#39;</span><span class="p">)</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="s1">&#39;prob_y_ticks&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">copy</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
                <span class="k">del</span> <span class="n">kwargs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">scale_attrs</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
                    <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
                            <span class="nb">getattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">*</span> <span class="n">value</span><span class="p">)</span>
                <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span>
                                <span class="nb">getattr</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="p">,</span> <span class="n">value</span><span class="p">))</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">diag1d_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;normalized&#39;</span><span class="p">:</span> <span class="n">normalize</span><span class="p">}</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_zero</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">diag1d_kwargs</span><span class="p">[</span><span class="s1">&#39;no_zero&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_zero</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_ylabel</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">diag1d_kwargs</span><span class="p">[</span><span class="s1">&#39;no_ylabel&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_ylabel</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">label_right</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">diag1d_kwargs</span><span class="p">[</span><span class="s1">&#39;label_right&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">label_right</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">no_ytick</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">diag1d_kwargs</span><span class="p">[</span><span class="s1">&#39;no_ytick&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">no_ytick</span>

        <span class="n">plotter</span><span class="o">.</span><span class="n">triangle_plot</span><span class="p">(</span><span class="n">getdist_bcknds</span><span class="p">,</span>
                               <span class="n">legend_labels</span> <span class="o">=</span> <span class="n">legend_labels</span><span class="p">,</span>
                               <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                               <span class="n">filled</span> <span class="o">=</span> <span class="n">filled</span><span class="p">,</span>
                               <span class="n">legend_loc</span> <span class="o">=</span> <span class="n">legend_loc</span><span class="p">,</span>
                               <span class="n">line_args</span> <span class="o">=</span> <span class="n">line_args</span><span class="p">,</span>
                               <span class="n">contour_args</span> <span class="o">=</span> <span class="n">contour_args</span><span class="p">,</span>
                               <span class="n">diag1d_kwargs</span> <span class="o">=</span> <span class="n">diag1d_kwargs</span><span class="p">,</span>
                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">legend_corner_coords</span><span class="p">:</span>
                <span class="n">plotter</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">set_bbox_to_anchor</span><span class="p">(</span><span class="n">legend_corner_coords</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">plotter</span><span class="o">.</span><span class="n">legend</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="n">legend_frameon</span><span class="p">)</span>

        <span class="c1"># add custom parameter plotting limits and updated autolocation</span>
        <span class="k">with</span> <span class="n">fragile</span><span class="p">(</span><span class="n">verbose</span><span class="p">(</span><span class="n">param_plot_lims</span><span class="p">,</span>
                             <span class="s1">&#39;Applying bespoke parameter viewing intervals&#39;</span><span class="p">,</span>
                             <span class="s1">&#39;Viewing intervals applied&#39;</span><span class="p">))</span> <span class="k">as</span> <span class="n">condition</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span> <span class="n">fragile</span><span class="o">.</span><span class="n">Break</span>

            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span>
            <span class="k">for</span> <span class="n">param</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">param_plot_lims</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">j</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">)):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="n">prune</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">j</span><span class="p">):</span>
                    <span class="n">ax</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">i</span><span class="p">]</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="n">prune</span><span class="p">))</span>
                    <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">prior_density</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_prior_density</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span>
                                    <span class="n">KL_divergence</span><span class="p">,</span> <span class="n">KL_base</span><span class="p">,</span>
                                    <span class="n">ID</span><span class="o">=</span><span class="n">ID_for_1D_estimators</span><span class="p">,</span>
                                    <span class="n">bootstrap</span><span class="o">=</span><span class="n">bootstrap</span><span class="p">,</span>
                                    <span class="n">n_simulate</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_simulate&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">veneer</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_veneer_spines_ticks</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">crosshairs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_crosshairs</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">truths</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">credible_interval_1d</span><span class="p">:</span> <span class="c1"># include nestcheck estimator bootstrap error</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_credible_interval</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span>
                                        <span class="n">bootstrap</span><span class="o">=</span><span class="n">bootstrap</span><span class="p">,</span>
                                        <span class="n">n_simulate</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;n_simulate&#39;</span><span class="p">),</span>
                                        <span class="n">ID</span><span class="o">=</span><span class="n">ID_for_1D_estimators</span><span class="p">,</span>
                                        <span class="n">annotate</span><span class="o">=</span><span class="n">annotate_credible_interval</span><span class="p">,</span>
                                        <span class="n">annotate_xy</span><span class="o">=</span><span class="n">annotate_xy</span><span class="p">,</span>
                                        <span class="n">sixtyeight</span><span class="o">=</span><span class="n">sixtyeight</span><span class="p">,</span>
                                        <span class="n">ninety</span><span class="o">=</span><span class="n">ninety</span><span class="p">,</span>
                                        <span class="n">compute_all_intervals</span><span class="o">=</span><span class="n">compute_all_intervals</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_plotter</span> <span class="o">=</span> <span class="n">plotter</span>
        <span class="k">return</span> <span class="n">plotter</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding 1D marginal prior density functions&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Added 1D marginal prior density functions&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_prior_density</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotter</span><span class="p">,</span> <span class="n">ndraws</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span>
                           <span class="n">KL_divergence</span><span class="p">,</span> <span class="n">KL_base</span><span class="p">,</span>
                           <span class="n">ID</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">,</span> <span class="n">n_simulate</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Crudely estimate the prior density.</span>

<span class="sd">        Kullback-Leibler divergence estimated in bits for a combined run or</span>
<span class="sd">        the same run for which the credible intervals are calculated.</span>

<span class="sd">        .. todo::</span>

<span class="sd">            * Apply GetDist KDE to 1D marginal distributions manually so that</span>
<span class="sd">              density at boundaries is accurate. SciPy probably will not</span>
<span class="sd">              handle boundary correction and density is often appreciable</span>
<span class="sd">              at boundaries for weakly informative prior density functions.</span>
<span class="sd">            * Plot multiple priors if there are multiple likelihood functions?</span>
<span class="sd">            * Add prior-to-posterior KL-divergence functionality for 1D</span>
<span class="sd">              marginal distributions using Guassian KDE for prior density</span>
<span class="sd">              function.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span>

        <span class="k">if</span> <span class="n">l</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="s1">&#39;prior&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="p">,</span> <span class="s1">&#39;inverse_sample&#39;</span><span class="p">):</span>
            <span class="k">return</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">h</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">ndraws</span><span class="p">),</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">num_params</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample_and_transform</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">int</span><span class="p">(</span><span class="n">ndraws</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)),</span>
                                <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">finite_counter</span> <span class="o">=</span> <span class="n">counter</span> <span class="o">=</span> <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">while</span> <span class="n">finite_counter</span> <span class="o">&lt;</span> <span class="n">ndraws</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample_and_transform</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span> <span class="c1"># use estimate to draw more from hypercube</span>
                <span class="n">redraw</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">counter</span><span class="p">)</span> <span class="o">*</span> <span class="n">ndraws</span> <span class="o">/</span> <span class="n">finite_counter</span>
                <span class="n">redraw</span> <span class="o">-=</span> <span class="n">finite_counter</span>
                <span class="n">h</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">rand</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">redraw</span><span class="p">)</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">num_params</span><span class="p">))</span>
                <span class="n">index</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample_and_transform</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="n">p</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="o">.</span><span class="n">inverse_sample</span><span class="p">(</span><span class="n">h</span><span class="p">[</span><span class="n">index</span><span class="p">,</span> <span class="p">:])</span>

            <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">isfinite</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">prior</span><span class="p">(</span><span class="n">p</span><span class="p">)):</span>
                <span class="n">samples</span><span class="p">[</span><span class="n">finite_counter</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">p</span>
                <span class="n">finite_counter</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="n">counter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
        <span class="n">color</span><span class="p">,</span> <span class="n">lw</span> <span class="o">=</span> <span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">contours</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;color&#39;</span><span class="p">,</span> <span class="s1">&#39;lw&#39;</span><span class="p">))</span>

        <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>

        <span class="k">with</span> <span class="n">verbose</span><span class="p">(</span><span class="n">KL_divergence</span><span class="p">,</span>
                     <span class="s1">&#39;Estimating 1D marginal KL-divergences in </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">KL_base</span><span class="p">,</span>
                     <span class="s1">&#39;Estimated 1D marginal KL-divergences&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">condition</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ax</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> \
                                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]):</span>

                <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">bounds</span> <span class="o">=</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>
                <span class="n">settings</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;fine_bins&#39;</span><span class="p">:</span> <span class="mi">1024</span><span class="p">,</span>
                            <span class="s1">&#39;smooth_scale_1D&#39;</span><span class="p">:</span> <span class="mf">0.3</span><span class="p">,</span>
                            <span class="s1">&#39;boundary_correction_order&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="s1">&#39;mult_bias_correction_order&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span> <span class="c1"># adopt from posterior settings or take custom input?</span>

                <span class="n">bcknd</span> <span class="o">=</span> <span class="n">getdist</span><span class="o">.</span><span class="n">mcsamples</span><span class="o">.</span><span class="n">MCSamples</span><span class="p">(</span><span class="n">sampler</span><span class="o">=</span><span class="s1">&#39;uncorrelated&#39;</span><span class="p">,</span>
                                <span class="n">samples</span><span class="o">=</span><span class="n">samples</span><span class="p">[:,</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                <span class="n">weights</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="n">name</span><span class="p">],</span>
                                <span class="n">ranges</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                                <span class="n">settings</span><span class="o">=</span><span class="n">settings</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">normalize</span><span class="p">:</span>
                    <span class="n">bcknd</span><span class="o">.</span><span class="n">get1DDensity</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">normalize</span><span class="p">(</span><span class="n">by</span><span class="o">=</span><span class="s1">&#39;integral&#39;</span><span class="p">,</span>
                                                       <span class="n">in_place</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

                <span class="n">x</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()[</span><span class="mi">1</span><span class="p">],</span>
                                 <span class="mi">1000</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">bcknd</span><span class="o">.</span><span class="n">get1DDensity</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">Prob</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                        <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-.&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">condition</span><span class="p">:</span> <span class="k">continue</span>

                <span class="c1"># a prototype Kullback-Leibler divergence callback</span>
                <span class="c1"># information in bits</span>
                <span class="k">def</span> <span class="nf">KL</span><span class="p">(</span><span class="n">ns_run</span><span class="p">,</span> <span class="n">logw</span><span class="p">):</span>
                    <span class="n">x</span> <span class="o">=</span> <span class="n">ns_run</span><span class="p">[</span><span class="s1">&#39;theta&#39;</span><span class="p">][:,</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">idxs</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
                    <span class="n">w_rel</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logw</span> <span class="o">-</span> <span class="n">logw</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
                    <span class="n">where</span> <span class="o">=</span> <span class="n">w_rel</span> <span class="o">&gt;</span> <span class="n">run</span><span class="o">.</span><span class="n">kde_settings</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;min_weight_ratio&#39;</span><span class="p">,</span>
                                                         <span class="mf">1.0e-30</span><span class="p">)</span>
                    <span class="n">prior</span> <span class="o">=</span> <span class="n">bcknd</span><span class="o">.</span><span class="n">get1DDensity</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">Prob</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">])</span>
                    <span class="n">posterior</span> <span class="o">=</span> <span class="n">getdist_kde</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="n">where</span><span class="p">],</span> <span class="n">x</span><span class="p">,</span> <span class="n">w_rel</span><span class="p">,</span>
                                        <span class="n">ranges</span><span class="o">=</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">bounds</span><span class="p">[</span><span class="n">i</span><span class="p">]],</span>
                                        <span class="n">idx</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                        <span class="n">normalize</span><span class="o">=</span><span class="n">normalize</span><span class="p">,</span>
                                        <span class="n">settings</span><span class="o">=</span><span class="n">run</span><span class="o">.</span><span class="n">kde_settings</span><span class="p">)</span>
                    <span class="c1"># Due to spline interpolation, very small densities can be</span>
                    <span class="c1"># negative, so manually give a small postive value which</span>
                    <span class="c1"># does not affect KL integral approximation</span>
                    <span class="n">posterior</span><span class="p">[</span><span class="n">posterior</span><span class="o">&lt;=</span><span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="n">posterior</span><span class="p">[</span><span class="n">posterior</span><span class="o">&gt;</span><span class="mf">0.0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>

                    <span class="n">KL</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_rel</span><span class="p">[</span><span class="n">where</span><span class="p">]</span> \
                                   <span class="o">*</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">posterior</span><span class="p">)</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prior</span><span class="p">)))</span> \
                                   <span class="o">/</span><span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_rel</span><span class="p">[</span><span class="n">where</span><span class="p">])</span>

                    <span class="k">if</span> <span class="n">KL_base</span> <span class="o">==</span> <span class="s1">&#39;bits&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">KL</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">KL_base</span> <span class="o">==</span> <span class="s1">&#39;nats&#39;</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">KL</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid base for KL-divergence.&#39;</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">bootstrap</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cred_int</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]):</span>
                        <span class="n">quantiles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_ci_bootstrap</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">,</span>
                                                     <span class="n">estimator_list</span><span class="o">=</span><span class="p">[</span><span class="n">KL</span><span class="p">],</span>
                                                     <span class="n">cred_int</span><span class="o">=</span><span class="n">cred_int</span><span class="p">,</span>
                                                     <span class="n">n_simulate</span><span class="o">=</span><span class="n">n_simulate</span><span class="p">,</span>
                                                     <span class="n">simulate_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                     <span class="n">flip_skew</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                    <span class="c1"># KL in bits</span>
                    <span class="n">interval</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$D_{\mathrm</span><span class="si">{KL}</span><span class="s1">}=</span><span class="si">%.2f</span><span class="s1">_{-</span><span class="si">%.2f</span><span class="s1">}^{+</span><span class="si">%.2f</span><span class="s1">}$&#39;</span> \
                                                  <span class="o">%</span> <span class="p">(</span><span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                     <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">quantiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> KL-divergence = </span><span class="si">%.4f</span><span class="s1">/-</span><span class="si">%.4f</span><span class="s1">/+</span><span class="si">%.4f</span><span class="s1">&#39;</span>
                            <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span>
                               <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                               <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">quantiles</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">quantiles</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">interval</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">where</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">where</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span>
                    <span class="n">__</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">where</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

                    <span class="n">ns_run</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">}</span>
                    <span class="n">divergence</span> <span class="o">=</span> <span class="n">KL</span><span class="p">(</span><span class="n">ns_run</span><span class="p">,</span> <span class="n">__</span><span class="p">)</span>

                    <span class="n">divergence</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_{\mathrm</span><span class="si">{KL}</span><span class="s1">}=</span><span class="si">%.2f</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="n">divergence</span><span class="p">)</span>

                    <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">divergence</span><span class="p">))</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">divergence</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

        <span class="k">yield</span> <span class="kc">None</span>

<div class="viewcode-block" id="PostProcessor.KL_divergence"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.PostProcessor.KL_divergence">[docs]</a>    <span class="k">def</span> <span class="nf">KL_divergence</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base</span><span class="o">=</span><span class="s1">&#39;bits&#39;</span><span class="p">,</span> <span class="n">bootstrap</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">ID</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">n_simulate</span><span class="o">=</span><span class="mi">200</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Kullback-Leibler divergence integral jointly for all parameters. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">ID</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>

        <span class="k">def</span> <span class="nf">estimator</span><span class="p">(</span><span class="n">ns_run</span><span class="p">,</span> <span class="n">logw</span><span class="p">):</span>
            <span class="n">w_rel</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">logw</span> <span class="o">-</span> <span class="n">logw</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
            <span class="n">KL</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_rel</span> <span class="o">*</span> <span class="n">ns_run</span><span class="p">[</span><span class="s1">&#39;logl&#39;</span><span class="p">])</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w_rel</span><span class="p">)</span>
            <span class="n">KL</span> <span class="o">-=</span> <span class="n">logsumexp</span><span class="p">(</span><span class="n">logw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;bits&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">KL</span> <span class="o">/</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">base</span> <span class="o">==</span> <span class="s1">&#39;nats&#39;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">KL</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid base for KL-divergence.&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">bootstrap</span><span class="p">:</span>
            <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span>
            <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">cred_int</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]):</span>
                <span class="n">quantiles</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_ci_bootstrap</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">,</span>
                                                 <span class="n">estimator_list</span><span class="o">=</span><span class="p">[</span><span class="n">estimator</span><span class="p">],</span>
                                                 <span class="n">cred_int</span><span class="o">=</span><span class="n">cred_int</span><span class="p">,</span>
                                                 <span class="n">n_simulate</span><span class="o">=</span><span class="n">n_simulate</span><span class="p">,</span>
                                                 <span class="n">simulate_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                                 <span class="n">flip_skew</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">quantiles</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">divergence</span> <span class="o">=</span> <span class="n">estimator</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">,</span>
                                   <span class="n">get_logw</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">divergence</span></div>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding 1D marginal credible intervals&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Added 1D marginal credible intervals&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_credible_interval</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">plotter</span><span class="p">,</span> <span class="n">bootstrap</span><span class="p">,</span> <span class="n">n_simulate</span><span class="p">,</span>
                               <span class="n">ID</span><span class="p">,</span> <span class="n">annotate</span><span class="p">,</span> <span class="n">annotate_xy</span><span class="p">,</span> <span class="n">sixtyeight</span><span class="p">,</span>
                               <span class="n">ninety</span><span class="p">,</span> <span class="n">compute_all_intervals</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Estimate 1-\sigma credible interval in one-dimension on a</span>
<span class="sd">        combined run, or if such a run does not exist, on the run with</span>
<span class="sd">        the specified ID.</span>

<span class="sd">        Calls :func:`nestcheck.estimators.param_cred` for one-tailed weighted</span>
<span class="sd">        estimate; two such estimates give a credible interval which is</span>
<span class="sd">        symmetric in quantiles with respect to the median. Also calls</span>
<span class="sd">        :func:`nestcheck.error_analysis.run_ci_bootstrap` for</span>
<span class="sd">        credible interval on quantiles.</span>

<span class="sd">        :param bool sixtyeight:</span>
<span class="sd">            Plot the 68% credible interval about the median in 1D plots? If</span>
<span class="sd">            ``False`` plots 95% credible interval about the median -- i.e.,</span>
<span class="sd">            symmetric quantiles about the median.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">diag</span> <span class="o">=</span> <span class="p">[</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span>

        <span class="c1"># get the color of the run if ID is used, else red for combined</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">AttributeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="n">run</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span>
            <span class="n">color</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="p">[</span><span class="n">ID</span><span class="p">]</span><span class="o">.</span><span class="n">lines</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span>

        <span class="c1"># estimator requires closure to be changable</span>
        <span class="k">def</span> <span class="nf">get_estimator</span><span class="p">(</span><span class="n">quantile</span><span class="p">,</span> <span class="n">param_ind</span><span class="p">):</span>
            <span class="k">def</span> <span class="nf">estimator</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">param_cred</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span>
                                  <span class="n">probability</span><span class="o">=</span><span class="n">quantile</span><span class="p">,</span>
                                  <span class="n">param_ind</span><span class="o">=</span><span class="n">param_ind</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">estimator</span>

        <span class="n">quantiles</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.159</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.841</span><span class="p">]</span> <span class="k">if</span> <span class="n">sixtyeight</span> <span class="k">else</span> <span class="p">([</span><span class="mf">0.05</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.95</span><span class="p">]</span> <span class="k">if</span> <span class="n">ninety</span> <span class="k">else</span> <span class="p">[</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">format_CI</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">cred</span><span class="p">,</span> <span class="n">summary</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cred</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> CI_{</span><span class="si">%i</span><span class="s1">\</span><span class="si">%%</span><span class="s1">} = </span><span class="si">%.4f</span><span class="s1">/-</span><span class="si">%.4f</span><span class="s1">/+</span><span class="si">%.4f</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">summary</span><span class="p">,</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> CI_{</span><span class="si">%i</span><span class="s1">\</span><span class="si">%%</span><span class="s1">} = </span><span class="si">%.4f</span><span class="s1">/-</span><span class="si">%.4f</span><span class="s1">/+</span><span class="si">%.4f</span><span class="s1">&#39;</span>
                        <span class="o">%</span> <span class="p">(</span><span class="n">name</span><span class="p">,</span>
                           <span class="n">summary</span><span class="p">,</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                           <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>


            <span class="k">return</span> <span class="n">msg</span>

        <span class="k">if</span> <span class="n">bootstrap</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">idxs</span><span class="p">)):</span>
                <span class="k">def</span> <span class="nf">calculate_intervals</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
                    <span class="n">cred</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">q</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
                            <span class="n">cred</span><span class="p">[</span><span class="n">j</span><span class="p">,</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">run_ci_bootstrap</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">nestcheck_backend</span><span class="p">,</span>
                                             <span class="n">estimator_list</span><span class="o">=</span><span class="p">[</span><span class="n">get_estimator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ind</span><span class="p">)],</span>
                                             <span class="n">cred_int</span><span class="o">=</span><span class="n">q</span><span class="p">,</span>
                                             <span class="n">n_simulate</span><span class="o">=</span><span class="n">n_simulate</span><span class="p">,</span>
                                             <span class="n">simulate_weights</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">flip_skew</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="k">return</span> <span class="n">cred</span>

                <span class="n">cred</span> <span class="o">=</span> <span class="n">calculate_intervals</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
                <span class="n">zorder</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">zorder</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()])</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span>
                           <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">],</span> <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                           <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;CI$_{</span><span class="si">%d</span><span class="s1">\</span><span class="si">%%</span><span class="s1">}=</span><span class="si">%.2f</span><span class="s1">_{-</span><span class="si">%.2f</span><span class="s1">}^{+</span><span class="si">%.2f</span><span class="s1">}$&#39;</span> \
                                <span class="o">%</span> <span class="p">(</span><span class="mi">68</span> <span class="k">if</span> <span class="n">sixtyeight</span> <span class="k">else</span> <span class="p">(</span><span class="mi">90</span> <span class="k">if</span> <span class="n">ninety</span> <span class="k">else</span> <span class="mi">95</span><span class="p">),</span>
                                   <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                                   <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span> <span class="o">+</span> <span class="n">title</span><span class="o">.</span><span class="n">center</span><span class="p">(</span><span class="mi">30</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">stats</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">compute_all_intervals</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                    <span class="n">cred</span><span class="p">,</span>
                                    <span class="mi">68</span> <span class="k">if</span> <span class="n">sixtyeight</span> <span class="k">else</span> <span class="p">(</span><span class="mi">90</span> <span class="k">if</span> <span class="n">ninety</span> <span class="k">else</span> <span class="mi">95</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">sixtyeight</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]),</span>
                                        <span class="mi">90</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]),</span>
                                        <span class="mi">95</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ninety</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.159</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.841</span><span class="p">]),</span>
                                        <span class="mi">68</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]),</span>
                                        <span class="mi">95</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.159</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.841</span><span class="p">]),</span>
                                        <span class="mi">68</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]),</span>
                                        <span class="mi">90</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">ax</span><span class="p">,</span> <span class="n">ind</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">diag</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">idxs</span><span class="p">)):</span>
                <span class="k">def</span> <span class="nf">calculate_intervals</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
                    <span class="n">cred</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">quantiles</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">double</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">quantiles</span><span class="p">):</span>
                        <span class="n">where</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.0</span>
                        <span class="n">_</span> <span class="o">=</span> <span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">where</span><span class="p">,</span><span class="mi">2</span><span class="p">:]</span>
                        <span class="n">__</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">[</span><span class="n">where</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">cred</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_estimator</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">ind</span><span class="p">)({</span><span class="s1">&#39;theta&#39;</span><span class="p">:</span> <span class="n">_</span><span class="p">},</span> <span class="n">__</span><span class="p">)</span>

                    <span class="k">return</span> <span class="n">cred</span>

                <span class="n">cred</span> <span class="o">=</span> <span class="n">calculate_intervals</span><span class="p">(</span><span class="n">quantiles</span><span class="p">)</span>
                <span class="n">zorder</span> <span class="o">=</span> <span class="nb">max</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">zorder</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_children</span><span class="p">()])</span> <span class="o">+</span> <span class="mi">1</span>

                <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span>
                           <span class="n">facecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">edgecolor</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                           <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                           <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">zorder</span><span class="o">=</span><span class="n">zorder</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">annotate</span><span class="p">:</span>
                    <span class="n">stats</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;CI$_{</span><span class="si">%d</span><span class="s1">\</span><span class="si">%%</span><span class="s1">}=</span><span class="si">%.2f</span><span class="s1">_{-</span><span class="si">%.2f</span><span class="s1">}^{+</span><span class="si">%.2f</span><span class="s1">}$&#39;</span> \
                                                <span class="o">%</span> <span class="p">(</span><span class="mi">68</span> <span class="k">if</span> <span class="n">sixtyeight</span> <span class="k">else</span> <span class="mi">95</span><span class="p">,</span>
                                                   <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                                   <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                   <span class="n">cred</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">cred</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

                    <span class="n">title</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_title</span><span class="p">()</span>
                    <span class="k">if</span> <span class="n">title</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">stats</span> <span class="o">+</span> <span class="sa">r</span><span class="s1">&#39;  $|$  &#39;</span> <span class="o">+</span> <span class="n">title</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">title</span> <span class="o">=</span> <span class="n">stats</span>

                    <span class="k">if</span> <span class="ow">not</span> <span class="n">rcParams</span><span class="p">[</span><span class="s1">&#39;text.usetex&#39;</span><span class="p">]:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">settings</span><span class="o">.</span><span class="n">lab_fontsize</span>

                    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">,</span>
                                 <span class="n">fontsize</span><span class="o">=</span><span class="n">fontsize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">compute_all_intervals</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                    <span class="n">cred</span><span class="p">,</span>
                                    <span class="mi">68</span> <span class="k">if</span> <span class="n">sixtyeight</span> <span class="k">else</span> <span class="p">(</span><span class="mi">90</span> <span class="k">if</span> <span class="n">ninety</span> <span class="k">else</span> <span class="mi">95</span><span class="p">))</span>

                    <span class="k">if</span> <span class="n">sixtyeight</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]),</span>
                                        <span class="mi">90</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]),</span>
                                        <span class="mi">95</span><span class="p">)</span>
                    <span class="k">elif</span> <span class="n">ninety</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.159</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.841</span><span class="p">]),</span>
                                        <span class="mi">68</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.975</span><span class="p">]),</span>
                                        <span class="mi">95</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.159</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.841</span><span class="p">]),</span>
                                        <span class="mi">68</span><span class="p">)</span>
                        <span class="k">yield</span> <span class="n">format_CI</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span>
                                        <span class="n">calculate_intervals</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">]),</span>
                                        <span class="mi">90</span><span class="p">)</span>

        <span class="k">yield</span> <span class="kc">None</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding parameter truth crosshairs&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Added crosshairs&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_crosshairs</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span> <span class="n">truths</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add parameter crosshairs to triangle plot. &quot;&quot;&quot;</span>
        <span class="n">spine</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">itervalues</span><span class="p">())</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">spine</span><span class="o">.</span><span class="n">get_linewidth</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">truth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">truths</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">truth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[:,</span><span class="n">i</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,:</span><span class="n">i</span><span class="p">]:</span>
                        <span class="k">if</span> <span class="n">ax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="n">truth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Veneering spines and axis ticks&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Veneered&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_veneer_spines_ticks</span><span class="p">(</span><span class="n">plotter</span><span class="p">,</span> <span class="n">lengthen</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">embolden</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span>
                             <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Embolden spines, and embolden and lengthen ticks. &quot;&quot;&quot;</span>

        <span class="n">ax</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">major_length</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_markersize</span><span class="p">()</span>
        <span class="n">major_length</span> <span class="o">*=</span> <span class="n">lengthen</span>
        <span class="n">minor_length</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">minorTicks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_markersize</span><span class="p">()</span>
        <span class="n">minor_length</span> <span class="o">*=</span> <span class="n">lengthen</span>
        <span class="n">lw</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">majorTicks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tick1line</span><span class="o">.</span><span class="n">get_markeredgewidth</span><span class="p">()</span>
        <span class="n">lw</span> <span class="o">*=</span> <span class="n">embolden</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plotter</span><span class="o">.</span><span class="n">subplots</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">]</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">major_length</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="n">minor_length</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="n">lw</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                    <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="n">lw</span><span class="p">)</span>

<div class="viewcode-block" id="PostProcessor.plot_pulse_and_spectrum"><a class="viewcode-back" href="../../postprocessing.html#xpsi.PostProcessing.PostProcessor.plot_pulse_and_spectrum">[docs]</a>    <span class="nd">@fix_random_seed</span>
    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Plotting data and model for posterior checking&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Plotted data and model for posterior checking&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">plot_pulse_and_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                                <span class="n">run_IDs</span><span class="p">,</span>
                                <span class="n">combine</span><span class="p">,</span>
                                <span class="n">combine_all</span><span class="p">,</span>
                                <span class="n">nsamples</span><span class="p">,</span>
                                <span class="n">num_phases</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                <span class="n">num_energies</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                <span class="n">cache</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">write</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                <span class="n">fig_dir</span> <span class="o">=</span> <span class="s1">&#39;./&#39;</span><span class="p">,</span>
                                <span class="n">root_filename</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>
                                <span class="n">extension</span> <span class="o">=</span> <span class="s1">&#39;.pdf&#39;</span><span class="p">,</span>
                                <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span>
                                <span class="n">use_fgivenx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="n">random_seed</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                <span class="n">absorbed_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Plot data and model for posterior checking.</span>

<span class="sd">        If a combined run is available, only this run is used. Otherwise</span>
<span class="sd">        a plot is generated for each run using the corresponding likelihood</span>
<span class="sd">        object. There may in principle be multiple :class:`~.Pulse.Pulse`</span>
<span class="sd">        instances per likelihood object, but only the first instance is used.</span>

<span class="sd">        Compute and plot posterior-averaged channel-summed count-rate pulse.</span>
<span class="sd">        The figure contains four panels which share phase as an x-axis:</span>

<span class="sd">            * the first (topmost) panel displays the data in joint channel-phase</span>
<span class="sd">              intervals</span>
<span class="sd">            * the second panel displays the posterior mean expectation in joint</span>
<span class="sd">              channel-phase intervals</span>
<span class="sd">            * the third panel displays the standardised residuals in joint</span>
<span class="sd">              channel-phase intervals</span>
<span class="sd">            * the last (bottommost) panel displays the channel-summed pulse as</span>
<span class="sd">              a function of phase for a subset of samples, optionally using</span>
<span class="sd">              :mod:`fgivenx`; the injected pulse is plotted by default if the</span>
<span class="sd">              injection (truth) vector is known.</span>

<span class="sd">        :param bool cache:</span>
<span class="sd">            Cache intermediary model objects to accelerate post-processing?</span>

<span class="sd">        :param int nsamples:</span>
<span class="sd">            Number of samples to use. Equally-weighted samples are generated,</span>
<span class="sd">            thus introducing a additional Monte Carlo noise which is ignored.</span>

<span class="sd">        :param int num_phases:</span>
<span class="sd">            Number of phases to interpolate at on the interval [0,2] cycles.</span>

<span class="sd">        :param bool use_fgivenx:</span>
<span class="sd">            Use :mod:`fgivenx` to plot iso-probability credible interval</span>
<span class="sd">            contours in target-source count rate as a function of phase.</span>

<span class="sd">        :param int random_seed:</span>
<span class="sd">            Seed :mod:`numpy.random` for determinism.</span>

<span class="sd">        :param kwargs:</span>
<span class="sd">            Keyword arguments for the following:</span>

<span class="sd">                * :meth:`_SignalPlot.add_expected_source`</span>

<span class="sd">        .. todo::</span>

<span class="sd">            * Use tqdm for progress bar.</span>
<span class="sd">            * Bootstrap and weight simulation via nestcheck for additional</span>
<span class="sd">              variation?</span>
<span class="sd">            * Return plot objects for the user handling?</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_set_runs_to_plot</span><span class="p">(</span><span class="n">run_IDs</span><span class="p">,</span> <span class="n">combine</span><span class="p">,</span> <span class="n">combine_all</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">combine</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span><span class="p">[</span><span class="n">run_IDs</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span> <span class="o">=</span> <span class="n">_SignalPlot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="nb">int</span><span class="p">(</span><span class="n">num_phases</span><span class="p">),</span>
                                           <span class="nb">int</span><span class="p">(</span><span class="n">num_energies</span><span class="p">),</span>
                                           <span class="n">use_fgivenx</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse_and_spectrum_driver</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span>
                                            <span class="n">l</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span>
                                            <span class="n">nsamples</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">truth_vector</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span><span class="p">,</span> <span class="n">use_fgivenx</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span>
                                            <span class="n">absorbed_spectrum</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

            <span class="n">root_filename</span> <span class="o">=</span> <span class="p">(</span><span class="n">root_filename</span> <span class="o">+</span> <span class="s1">&#39;__&#39;</span> <span class="k">if</span> <span class="n">root_filename</span> <span class="k">else</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="o">+</span> \
                            <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">combined</span><span class="o">.</span><span class="n">ID</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">,</span> <span class="n">root_filename</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span>
                                         <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">run</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_runs</span><span class="o">.</span><span class="n">subset</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span><span class="p">[</span><span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                    <span class="n">l</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_likelihood</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span> <span class="o">=</span> <span class="n">_SignalPlot</span><span class="p">(</span><span class="n">l</span><span class="o">.</span><span class="n">pulses</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                               <span class="nb">int</span><span class="p">(</span><span class="n">num_phases</span><span class="p">),</span>
                                               <span class="nb">int</span><span class="p">(</span><span class="n">num_energies</span><span class="p">),</span>
                                               <span class="n">use_fgivenx</span><span class="p">,</span>
                                               <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse_and_spectrum_driver</span><span class="p">(</span><span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span>
                                                <span class="n">run</span><span class="o">.</span><span class="n">samples</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span>
                                                <span class="n">run</span><span class="o">.</span><span class="n">truth_vector</span><span class="p">,</span>
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span><span class="p">,</span>
                                                <span class="n">use_fgivenx</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span>
                                                <span class="n">absorbed_spectrum</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">write</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">fig_dir</span><span class="p">,</span> <span class="n">run</span><span class="o">.</span><span class="n">ID</span><span class="p">,</span> <span class="n">extension</span><span class="p">,</span>
                                             <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span></div>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">signalPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span>

    <span class="nd">@signalPlot</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">signalPlot</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">_SignalPlot</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_signalPlot</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_draw_equally_weighted</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span> <span class="n">num_params</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get a set of equally weighted samples from a weighted set.</span>

<span class="sd">        ..note::</span>
<span class="sd">            Additional Monte Carlo noise from trimming sample set ignored.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">assert</span> <span class="n">nsamples</span> <span class="o">&lt;</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s1">&#39;Number of samples for plotting </span><span class="se">\</span>
<span class="s1">                                             cannot exceed number of nested </span><span class="se">\</span>
<span class="s1">                                             samples.&#39;</span>

        <span class="n">weights</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mf">0.01</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Warning: 1 - (sum of weights) = </span><span class="si">%.8e</span><span class="s1">&#39;</span><span class="o">%</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Weights renormalized to sum to unity.&#39;</span><span class="p">)</span>

        <span class="n">weights</span> <span class="o">/=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>

        <span class="n">indices</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nsamples</span><span class="p">,</span>
                                    <span class="n">replace</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="n">weights</span><span class="p">)</span>
        <span class="n">thetas</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[</span><span class="n">indices</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="o">+</span><span class="n">num_params</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">thetas</span>

    <span class="k">def</span> <span class="nf">_pulse_and_spectrum_driver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">likelihood</span><span class="p">,</span> <span class="n">samples</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span>
                                   <span class="n">truths</span><span class="p">,</span> <span class="n">signalplot</span><span class="p">,</span>
                                   <span class="n">use_fgivenx</span><span class="p">,</span> <span class="n">cache</span><span class="p">,</span>
                                   <span class="n">absorbed_spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Execute plotting loop given samples.</span>

<span class="sd">        .. todo::</span>
<span class="sd">            Use tqdm for progress bar whilst caching.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">thetas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_draw_equally_weighted</span><span class="p">(</span><span class="n">samples</span><span class="p">,</span> <span class="n">nsamples</span><span class="p">,</span>
                                             <span class="n">likelihood</span><span class="o">.</span><span class="n">num_params</span><span class="p">)</span>

        <span class="n">pulse</span> <span class="o">=</span> <span class="n">signalplot</span><span class="o">.</span><span class="n">pulse</span>

        <span class="k">if</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">h5py</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">filename</span> <span class="o">=</span> <span class="n">ID</span> <span class="o">+</span> <span class="s1">&#39;__pulse_&#39;</span> <span class="o">+</span> <span class="n">pulse</span><span class="o">.</span><span class="n">tag</span>
            <span class="n">cache</span> <span class="o">=</span> <span class="n">_Cache</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">cache</span><span class="o">.</span><span class="n">do_caching</span><span class="p">(</span><span class="n">thetas</span><span class="p">):</span> <span class="c1"># skips body if can simply read cache</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                    <span class="n">likelihood</span><span class="p">(</span><span class="n">thetas</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">cache</span><span class="p">(</span><span class="n">pulse</span><span class="o">.</span><span class="n">caching_targets</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">cache</span> <span class="ow">and</span> <span class="n">h5py</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;You need to install h5py to use caching.&#39;</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">update</span><span class="p">(</span><span class="n">theta</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">cache</span><span class="p">:</span> <span class="c1"># use the cache if available</span>
                <span class="n">cached</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">cache</span><span class="p">)</span>
                <span class="n">unique_keys</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">cached</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="nb">delattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                        <span class="k">pass</span>

                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                            <span class="nb">setattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">[</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">])</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">setattr</span><span class="p">(</span><span class="n">pulse</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span> <span class="c1"># otherwise resort to likelihood evaluations</span>
                <span class="n">likelihood</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_fgivenx</span><span class="p">:</span>
            <span class="k">def</span> <span class="nf">wrap</span><span class="p">(</span><span class="n">index</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">cache</span><span class="p">:</span>
                    <span class="n">cache</span><span class="o">.</span><span class="n">reset_iterator</span><span class="p">()</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">signalplot</span><span class="o">.</span><span class="n">model_sum</span>
                <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">def</span> <span class="nf">callback</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">theta</span><span class="p">):</span>
                    <span class="c1"># Ignore x because it is already known by a plot object in</span>
                    <span class="c1"># this more object oriented approach to calling fgivenx</span>
                    <span class="n">update</span><span class="p">(</span><span class="n">theta</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">signalplot</span><span class="o">.</span><span class="n">update_expectations</span><span class="p">(</span><span class="n">absorbed_spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">callback</span>

            <span class="n">signalplot</span><span class="o">.</span><span class="n">add_source_contours</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="n">signalplot</span><span class="o">.</span><span class="n">add_folded_contours</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">absorbed_spectrum</span><span class="p">:</span>
                <span class="n">signalplot</span><span class="o">.</span><span class="n">add_spectrum_contours</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">signalplot</span><span class="o">.</span><span class="n">add_spectrum_contours</span><span class="p">(</span><span class="n">wrap</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">thetas</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">update</span><span class="p">(</span><span class="n">thetas</span><span class="p">[</span><span class="n">i</span><span class="p">,:])</span>
                <span class="n">signalplot</span><span class="o">.</span><span class="n">update_expectations</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="kc">None</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">truths</span><span class="p">:</span>
            <span class="n">likelihood</span><span class="p">(</span><span class="n">truths</span><span class="p">[:</span><span class="n">likelihood</span><span class="o">.</span><span class="n">num_params</span><span class="p">])</span>

        <span class="n">signalplot</span><span class="o">.</span><span class="n">add_data</span><span class="p">()</span>
        <span class="n">signalplot</span><span class="o">.</span><span class="n">add_expected_counts</span><span class="p">()</span>
        <span class="n">signalplot</span><span class="o">.</span><span class="n">add_expected_source</span><span class="p">(</span><span class="n">absorbed_spectrum</span><span class="o">=</span><span class="n">absorbed_spectrum</span><span class="p">,</span>
                                       <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<span class="k">class</span> <span class="nc">_Cache</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Cache numerical model objects computed during likelihood evaluation.</span>


<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">filename</span><span class="p">,</span> <span class="n">base_dir</span><span class="o">=</span><span class="s1">&#39;./&#39;</span><span class="p">,</span>
                 <span class="n">read_only</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">archive</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">six</span><span class="o">.</span><span class="n">string_types</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">filename</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;.h5&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span> <span class="o">=</span> <span class="n">filename</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_base_dir</span> <span class="o">=</span> <span class="n">base_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_path</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_dir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="o">=</span> <span class="n">read_only</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_archive_if_incompatible</span> <span class="o">=</span> <span class="n">archive</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">traceback</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">exc</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Encountered problem whilst caching:&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_open</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the :mod:`h5py` context manager. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_read_only</span> <span class="ow">and</span> <span class="n">mode</span> <span class="o">!=</span> <span class="s1">&#39;r&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;The cache is in read-only mode.&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">h5py</span><span class="o">.</span><span class="n">File</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_path</span><span class="p">,</span> <span class="n">mode</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cache</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Cache the computational data. &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;r+&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">iteritems</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">value</span><span class="p">)]</span>
                        <span class="n">shape</span> <span class="o">+=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">value</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

                    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
                        <span class="n">g</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="n">j</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                        <span class="n">shape</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]]</span> <span class="o">+</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">shape</span><span class="p">]</span>
                        <span class="n">g</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>

                    <span class="n">g</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">reset_iterator</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Reset the counter for the cache iterator. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">__iter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reset_iterator</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span>

    <span class="k">def</span> <span class="nf">__next__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Read from the cache. &quot;&quot;&quot;</span>

        <span class="n">cached</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">g</span> <span class="o">=</span> <span class="n">f</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">cached</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">g</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">i</span><span class="p">,</span><span class="o">...</span><span class="p">]</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">cached</span>

    <span class="k">def</span> <span class="nf">next</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Python 2.x compatibility. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="fm">__next__</span><span class="p">()</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Checking whether an existing cache can be read:&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Cache state determined&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">do_caching</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether a new cache is required or whether an exising</span>
<span class="sd">            cache can be read without additional computation.</span>

<span class="sd">        :return: Boolean indicating whether to read (``False``) or write.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span> <span class="c1"># try reading file and checking keys</span>
            <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="k">if</span> <span class="s1">&#39;thetas&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
                    <span class="k">return</span> <span class="kc">True</span>
        <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span> <span class="c1"># create new cache file</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span> <span class="c1"># can be read, so check if samples array are matching</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_changed</span><span class="p">(</span><span class="n">samples</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_new</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Creating new cache file&#39;</span><span class="p">,</span> <span class="s1">&#39;Cache file created&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_new</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Prepare a new cache file. &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_dir</span><span class="p">):</span>
            <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_dir</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_archive_if_incompatible</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">):</span>
                    <span class="k">pass</span>
            <span class="k">except</span> <span class="ne">IOError</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initialise</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_archive</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_initialise</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_initialise</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Initialising cache file&#39;</span><span class="p">,</span> <span class="s1">&#39;Cache file initialised&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_initialise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Initialise the cache. &quot;&quot;&quot;</span>

        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">__version__</span>
            <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;n&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_dataset</span><span class="p">(</span><span class="s1">&#39;thetas&#39;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">samples</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">create_group</span><span class="p">(</span><span class="s1">&#39;/data&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">reset_iterator</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_changed</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">samples</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Check whether sample set has changed. &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open</span><span class="p">(</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">f</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s1">&#39;version&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">__version__</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_np</span><span class="o">.</span><span class="n">array_equal</span><span class="p">(</span><span class="n">f</span><span class="p">[</span><span class="s1">&#39;thetas&#39;</span><span class="p">],</span> <span class="n">samples</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">True</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Attempting to archive existing cache file in &#39;</span>
                  <span class="s1">&#39;a subdirectory&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_archive</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Archive an existing cache file. &quot;&quot;&quot;</span>

        <span class="c1"># to archive the existing cache file</span>
        <span class="n">archive_dir</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_base_dir</span><span class="p">,</span> <span class="s1">&#39;archive&#39;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">):</span>
                <span class="n">_os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Archiving failed... cache file </span><span class="si">%s</span><span class="s1"> will be &#39;</span>
                   <span class="s1">&#39;overwritten.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">yield</span> <span class="s1">&#39;Targeting subdirectory: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">archive_dir</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">datetime</span> <span class="k">import</span> <span class="n">datetime</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Archiving failed... cache file </span><span class="si">%s</span><span class="s1"> will be &#39;</span>
                   <span class="s1">&#39;overwritten.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
            <span class="k">yield</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">name_archived</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">[:</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;__archive__&#39;</span>
            <span class="n">name_archived</span> <span class="o">+=</span> <span class="s1">&#39;xpsi_version_</span><span class="si">%s</span><span class="s1">__&#39;</span> <span class="o">%</span> <span class="n">__version__</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">name_archived</span> <span class="o">+=</span> <span class="s1">&#39;datetime__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">__</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">.</span><span class="si">%i</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">obj</span><span class="o">.</span><span class="n">day</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">month</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">year</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span>
                                                               <span class="n">obj</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">_os</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">,</span>
                           <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">archive_dir</span><span class="p">,</span> <span class="n">name_archived</span> <span class="o">+</span> <span class="s1">&#39;.h5&#39;</span><span class="p">))</span>
            <span class="k">except</span> <span class="ne">OSError</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Archiving failed... cache file </span><span class="si">%s</span><span class="s1"> will be &#39;</span>
                       <span class="s1">&#39;overwritten.&#39;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filename</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Exisiting cache file archived in &#39;</span>
                       <span class="s1">&#39;subdirectory </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span> <span class="n">archive_dir</span><span class="p">)</span>

        <span class="k">yield</span> <span class="kc">None</span>

<span class="k">class</span> <span class="nc">_SignalPlot</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; A signal plot.</span>

<span class="sd">    Transform a single :class:`.Pulse.Pulse` instance into crude posterior</span>
<span class="sd">    predictive form.</span>

<span class="sd">    Compute and plot posterior-averaged channel count-rate spectrum.</span>

<span class="sd">    :param obj pulse: An instance of :class:`~.Pulse.Pulse`.</span>

<span class="sd">    :param bool rasterized:</span>
<span class="sd">        Beware if ``False``white polygon edges may appear in figures.</span>

<span class="sd">    :param tuple figsize:</span>
<span class="sd">        The size, ``(width, height)``, in inches per panel. Each panel</span>
<span class="sd">        extends over two phase cycles.</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Set figure size and label fontsizes automatically.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Instantiating a pulse plotter for posterior checking&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Pulse plotter instantiated&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">num_phases</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_energies</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                 <span class="n">use_fgivenx</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">rasterized</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                 <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">4</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="k">yield</span> <span class="p">(</span><span class="s1">&#39;Warning: pulse plots are generally better rendered such &#39;</span>
                   <span class="s1">&#39;that panel width is greater than panel height. Use the &#39;</span>
                   <span class="s1">&#39;``figsize`` argument to specify figure size per panel.&#39;</span><span class="p">)</span>

        <span class="n">fscale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;fscale&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">fontsize</span> <span class="o">=</span> <span class="n">fscale</span> <span class="o">*</span> <span class="mf">3.25</span> <span class="o">*</span> <span class="nb">min</span><span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">rc</span><span class="p">(</span><span class="s1">&#39;font&#39;</span><span class="p">,</span><span class="o">**</span><span class="p">{</span><span class="s1">&#39;size&#39;</span><span class="p">:</span> <span class="n">fontsize</span><span class="p">})</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span>

        <span class="c1"># figure for data, posterior expected model counts, and residuals</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_data</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_data</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                          <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">3</span><span class="p">,</span>
                                          <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_data</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="n">fscale</span><span class="p">)</span>

        <span class="c1">#temp refs for readability:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_data</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gs_data</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># figure for source signals, without interstellar effects, and folded</span>
        <span class="c1"># but no background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_source</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">4</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_source</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                            <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">4</span><span class="p">,</span>
                                            <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_source</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="n">fscale</span><span class="p">)</span>

        <span class="c1"># temp refs for readability:</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_source</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gs_source</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">use_fgivenx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">use_fgivenx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># figure for source signals, without interstellar effects, and folded</span>
        <span class="c1"># and background</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_spectrum</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="n">figsize</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">figsize</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">3</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_spectrum</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                             <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_gs_spectrum</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.175</span><span class="o">*</span><span class="n">fscale</span><span class="p">)</span>

        <span class="c1"># temp refs for readability</span>
        <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_fig_spectrum</span>
        <span class="n">gs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_gs_spectrum</span>

        <span class="n">gs_top</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                                  <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                                  <span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
                                                  <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs_top</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">use_fgivenx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs_top</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">gs_bottom</span> <span class="o">=</span> <span class="n">gridspec</span><span class="o">.</span><span class="n">GridSpecFromSubplotSpec</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span>
                                                     <span class="n">subplot_spec</span><span class="o">=</span><span class="n">gs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="n">wspace</span><span class="o">=</span><span class="mf">0.025</span><span class="p">,</span>
                                                     <span class="n">hspace</span><span class="o">=</span><span class="mf">0.125</span><span class="o">*</span><span class="n">fscale</span><span class="p">,</span>
                                                     <span class="n">height_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span>
                                                     <span class="n">width_ratios</span><span class="o">=</span><span class="p">[</span><span class="mi">50</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs_bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_cb</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs_bottom</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">gs_bottom</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

        <span class="c1"># focus only on axes objects now</span>
        <span class="c1"># axes objects are split over figures</span>

        <span class="n">axes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span><span class="p">,</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">]</span>

        <span class="n">saxes</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="p">,</span>
                 <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="p">]</span>

        <span class="n">cbs</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_data_cb</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model_cb</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid_cb</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_cb</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_cb</span><span class="p">,</span>
               <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_cb</span><span class="p">]</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">cbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d_cb</span><span class="p">)</span>
            <span class="n">cbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d_cb</span><span class="p">)</span>
            <span class="n">cbs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident_cb</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># these are globally applicable settings</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span> <span class="o">+</span> <span class="n">saxes</span> <span class="o">+</span> <span class="n">cbs</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;major&#39;</span><span class="p">,</span>
                           <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span>
                           <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;black&#39;</span><span class="p">,</span> <span class="n">length</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">direction</span><span class="o">=</span><span class="s1">&#39;out&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_tick_params</span><span class="p">(</span><span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">spine</span> <span class="ow">in</span> <span class="n">ax</span><span class="o">.</span><span class="n">spines</span><span class="o">.</span><span class="n">itervalues</span><span class="p">():</span>
                <span class="n">spine</span><span class="o">.</span><span class="n">set_linewidth</span><span class="p">(</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># properties for phase each axis</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">axes</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.2</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.05</span><span class="p">))</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">ax</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">):</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\phi$ [cycles]&#39;</span><span class="p">)</span>

        <span class="c1"># set more specific properties</span>
        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="p">,</span>
                   <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span><span class="p">):</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Channel (PI)&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E$ [keV]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;photons/cm$^</span><span class="si">{2}</span><span class="s1">$/s&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;counts/s&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$E$ [keV]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;photons/keV/cm$^</span><span class="si">{2}</span><span class="s1">$/s&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                             <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\phi$ [cycles]&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.5</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">MultipleLocator</span><span class="p">(</span><span class="mf">0.1</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">2.0</span><span class="p">])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Channel (PI)&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;counts/s&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="n">saxes</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                         <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">&#39;both&#39;</span><span class="p">,</span>
                                             <span class="n">labelbottom</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">num_phases</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_energies</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="o">.</span><span class="n">logspace_energies_hires</span>

        <span class="c1">#self._energies = _np.logspace(_np.log10(self.pulse.logspace_energies[0]),</span>
        <span class="c1">#                              _np.log10(self.pulse.logspace_energies[-1]),</span>
        <span class="c1">#                              int(num_energies),</span>
        <span class="c1">#                              base=10.0)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_use_fgivenx</span> <span class="o">=</span> <span class="n">use_fgivenx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span> <span class="o">=</span> <span class="n">rasterized</span>

        <span class="k">yield</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span>

    <span class="nd">@pulse</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">Pulse</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid type for Pulse object.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="k">def</span> <span class="nf">_set_vminmax</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Compute minimum and maximum for data and model colorbars. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span>
                         <span class="n">_np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">),</span>
                         <span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">))</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding count data to topmost panel split &#39;</span>
                  <span class="s1">&#39;over two phase cycles&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Data added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_data</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display data in topmost panel. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_vminmax</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                                        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                        <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span>
                                        <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span>
                                        <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                                        <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                        <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span>
                                        <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span>
                                        <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                        <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">data</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_data</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_data_cb</span><span class="p">,</span>
                                     <span class="n">ticks</span><span class="o">=</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                     <span class="nb">format</span><span class="o">=</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_data_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">update_expectations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">absorbed_spectrum</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Update expected quantities. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">expected_counts</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span> <span class="o">*=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals_energy_intervals</span><span class="p">)</span>

            <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals_energy_intervals</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_folded_sums</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
            <span class="n">folded</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">folded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">folded</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">folded</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_folded_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_incident_sums</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals</span><span class="p">)</span>
            <span class="n">incident</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                        <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                        <span class="n">p</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="mf">0.0</span><span class="p">)</span>

                <span class="c1">#temp = energy_interpolator(1,</span>
                <span class="c1">#                           temp,</span>
                <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                <span class="c1">#                           _np.log10(self._energies))</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">incident</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">incident</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">incident</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_incident_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="k">if</span> <span class="n">absorbed_spectrum</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_absorbed_spectrum_incident_sums</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">absorbed_raw_signals</span><span class="p">)</span>
                <span class="n">incident_absorbed</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">absorbed_raw_signals</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                            <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                            <span class="n">p</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                            <span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1">#temp = energy_interpolator(1,</span>
                    <span class="c1">#                           temp,</span>
                    <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                    <span class="c1">#                           _np.log10(self._energies))</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">incident_absorbed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">incident_absorbed</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">incident_absorbed</span> <span class="o">+=</span> <span class="n">temp</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_absorbed_spectrum_incident_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span>

            <span class="n">spectrum_folded</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">spectrum_folded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spectrum_folded</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spectrum_folded</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum_folded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">spectrum_folded</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">background_signal</span><span class="o">/</span>\
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exposure_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_sum</span> <span class="o">=</span> <span class="n">spectrum_folded</span><span class="o">.</span><span class="n">T</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_1d_sums</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                        <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                        <span class="n">p</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_1d_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">expected_counts</span>
            <span class="n">source</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals_energy_intervals</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">source</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">source</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">folded</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">folded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">folded</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">folded</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_folded_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">incident</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                        <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                        <span class="n">p</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="mf">0.0</span><span class="p">)</span>

                <span class="c1">#temp = energy_interpolator(1,</span>
                <span class="c1">#                           temp,</span>
                <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                <span class="c1">#                           _np.log10(self._energies))</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">incident</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">incident</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">incident</span> <span class="o">+=</span> <span class="n">temp</span>

                <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_incident_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="k">if</span> <span class="n">absorbed_spectrum</span><span class="p">:</span>
                <span class="n">incident_absorbed</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">absorbed_raw_signals</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                            <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                            <span class="n">p</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                            <span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1">#temp = energy_interpolator(1,</span>
                    <span class="c1">#                           temp,</span>
                    <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                    <span class="c1">#                           _np.log10(self._energies))</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">incident_absorbed</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">incident_absorbed</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">incident_absorbed</span> <span class="o">+=</span> <span class="n">temp</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_absorbed_spectrum_incident_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">spectrum_folded</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">)):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                              <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">spectrum_folded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">spectrum_folded</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">spectrum_folded</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">spectrum_folded</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
                <span class="n">spectrum_folded</span><span class="p">[:,</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">background_signal</span><span class="o">/</span>\
                                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exposure_time</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_sum</span> <span class="o">+=</span> <span class="n">spectrum_folded</span><span class="o">.</span><span class="n">T</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                        <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                        <span class="n">p</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="mf">0.0</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_1d_sums</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_fgivenx</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="n">folded</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">incident_absorbed</span>
        <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>
            <span class="n">incident_absorbed</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_fgivenx</span><span class="p">:</span>
            <span class="k">return</span> <span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">folded</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span>
                    <span class="n">incident</span><span class="p">,</span>
                    <span class="n">incident_absorbed</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the current posterior sum of the count numbers. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span>

    <span class="nd">@model_sum</span><span class="o">.</span><span class="n">deleter</span>
    <span class="k">def</span> <span class="nf">model_sum</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">del</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the estimated posterior expectation of the count numbers. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_model_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding posterior expectation of phase-channel count signal&#39;</span>
                  <span class="s1">&#39;to second panel&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Posterior expected signal added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_expected_counts</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display posterior expectation of model in second panel. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_set_vminmax</span><span class="p">()</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                                          <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                          <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span>
                                          <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span>
                                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span>
                                          <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                          <span class="n">vmin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmin</span><span class="p">,</span>
                                          <span class="n">vmax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_vmax</span><span class="p">,</span>
                                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">model</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_model</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_model_cb</span><span class="p">,</span>
                                      <span class="n">ticks</span><span class="o">=</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                      <span class="nb">format</span><span class="o">=</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_model_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_model_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;Counts&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_resid</span><span class="p">()</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding residuals between data and &#39;</span>
                  <span class="s1">&#39;posterior expected signal to third panel&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Residuals added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">_add_resid</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display the residuals in the third panel. &quot;&quot;&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">counts</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span> <span class="o">/=</span> <span class="n">_np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="p">)</span>

        <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="c1"># change to channels for data only assuming contiguity</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">,</span>
                                          <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;PuOr&#39;</span><span class="p">),</span>
                                          <span class="n">vmin</span><span class="o">=-</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">)),</span>
                                          <span class="n">vmax</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">)),</span>
                                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">resid</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="n">resid</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">phases</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                          <span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">,</span>
                                          <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;PuOr&#39;</span><span class="p">),</span>
                                          <span class="n">vmin</span><span class="o">=-</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">)),</span>
                                          <span class="n">vmax</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_residuals</span><span class="p">)),</span>
                                          <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                          <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>
        <span class="n">resid</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resid_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">resid</span><span class="p">,</span> <span class="n">cax</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_resid_cb</span><span class="p">,</span>
                                      <span class="n">ticks</span><span class="o">=</span><span class="n">AutoLocator</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resid_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resid_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_resid_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;$(c_</span><span class="si">{ik}</span><span class="s1">-d_</span><span class="si">{ik}</span><span class="s1">)/\sqrt{c_</span><span class="si">{ik}</span><span class="s1">}$&#39;</span><span class="p">,</span>
                                 <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_source</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the expectations of the source components. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">component</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_folded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the expectations of the folded source components. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">component</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_folded_sums</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_incident</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the expectations of the incident source component spectra. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">component</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="k">for</span> <span class="n">component</span> \
                                             <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_incident_sums</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_incident_absorbed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the expectations of the incident source component spectra. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">component</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="k">for</span> <span class="n">component</span> \
                                    <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_absorbed_spectrum_incident_sums</span><span class="p">]</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_spectrum_folded</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the estimated posterior expectation of the count numbers. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_sum</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">_counter</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">expected_spectrum_folded_1d</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the expectations of the incident source component spectra. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">component</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_counter</span> <span class="k">for</span> <span class="n">component</span> \
                                             <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_1d_sums</span><span class="p">]</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding posterior expectation of source signals&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Added posterior expected source signals&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_expected_source</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                            <span class="n">expectation_line_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">plot_truth</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                            <span class="n">truth_line_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                            <span class="n">show_components</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="n">total_ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                            <span class="n">component_ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span>
                            <span class="n">absorbed_spectrum</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                            <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Display the posterior expectation of the source signal in the</span>
<span class="sd">            fourth panel.</span>

<span class="sd">        :param bool show_components:</span>
<span class="sd">            If the :class:`~.Pulse.Pulse` instance has multiple components,</span>
<span class="sd">            display the posterior expectations of those components as a</span>
<span class="sd">            function of phase.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">plot_truth</span> <span class="ow">and</span> <span class="n">truth_line_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">truth_line_kwargs</span> <span class="o">=</span> \
                <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;b&#39;</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_use_fgivenx</span> <span class="k">else</span> <span class="s1">&#39;darkgreen&#39;</span><span class="p">),</span>
                     <span class="n">ls</span><span class="o">=</span><span class="n">component_ls</span><span class="p">,</span>
                     <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                     <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">expectation_line_kwargs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">expectation_line_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                           <span class="n">ls</span><span class="o">=</span><span class="n">component_ls</span><span class="p">,</span>
                                           <span class="n">lw</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span>
                                           <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_components</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_source_sums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals_energy_intervals</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                  <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_source</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals_energy_intervals</span><span class="p">,</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_source</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">component</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">component</span>

        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="n">source</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">,</span>
                                            <span class="n">total</span><span class="p">,</span>
                                            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                            <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>

        <span class="n">source</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">energy_edges</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_source_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">source</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_cb</span><span class="p">,</span>
                                       <span class="n">ticks</span><span class="o">=</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                       <span class="nb">format</span><span class="o">=</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_source_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_source_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;photons/cm$^</span><span class="si">{2}</span><span class="s1">$/s&#39;</span><span class="p">,</span>
                                  <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="c1"># add folded source signal</span>
        <span class="k">if</span> <span class="n">plot_truth</span> <span class="ow">and</span> <span class="n">truth_line_kwargs</span><span class="p">:</span>
            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_ls</span>

        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_ls</span>

        <span class="k">if</span> <span class="n">show_components</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_folded_sums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">):</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                  <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="n">temp</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_folded</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="n">component</span><span class="p">,</span>
                                <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">shift</span><span class="p">):</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">interp</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                <span class="n">p</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_folded</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">component</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">component</span>

        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span> <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="n">folded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                            <span class="n">total</span><span class="p">,</span>
                                            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                            <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>

        <span class="n">folded</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                  <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_folded_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">folded</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_cb</span><span class="p">,</span>
                                       <span class="n">ticks</span><span class="o">=</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                       <span class="nb">format</span><span class="o">=</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_folded_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_folded_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_folded_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;counts/s&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">_get_default_formatter</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="c1"># add spectra</span>
        <span class="k">if</span> <span class="n">plot_truth</span> <span class="ow">and</span> <span class="n">truth_line_kwargs</span><span class="p">:</span>
            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_ls</span>
            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;darkblue&#39;</span>

        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">component_ls</span>
        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;color&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;black&#39;</span>

        <span class="n">view_y_bottom</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">get_view_interval</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">show_components</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_incident_sums</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals</span><span class="p">:</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                            <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                            <span class="n">p</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                            <span class="mf">0.0</span><span class="p">)</span>

                    <span class="c1">#temp = energy_interpolator(1,</span>
                    <span class="c1">#                           temp,</span>
                    <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                    <span class="c1">#                           _np.log10(self._energies))</span>
                    <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                                <span class="n">temp</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_incident</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                            <span class="n">component</span><span class="p">,</span>
                                            <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">absorbed_spectrum</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_incident_absorbed</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                                <span class="n">component</span><span class="p">,</span>
                                                <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_spectrum_folded_1d</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_add_folded_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="p">,</span>
                                          <span class="n">component</span><span class="p">,</span>
                                          <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">plot_truth</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">raw_signals</span><span class="p">:</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">phase_integrator</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span>
                                        <span class="n">_np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">1.0</span><span class="p">]),</span>
                                        <span class="n">p</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">phases</span><span class="p">,</span>
                                        <span class="mf">0.0</span><span class="p">)</span>

                <span class="c1">#temp = energy_interpolator(1,</span>
                <span class="c1">#                           temp,</span>
                <span class="c1">#                           _np.log10(self._pulse.logspace_energies),</span>
                <span class="c1">#                           _np.log10(self._energies))</span>
                <span class="n">temp</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">temp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">temp</span>

            <span class="n">truth_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                        <span class="n">total</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">truth_line_kwargs</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_incident</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">component</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">component</span>

        <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                    <span class="n">total</span><span class="p">,</span>
                                    <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">absorbed_spectrum</span><span class="p">:</span>
            <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_incident_absorbed</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">=</span> <span class="n">component</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">total</span> <span class="o">+=</span> <span class="n">component</span>

            <span class="n">expectation_line_kwargs</span><span class="p">[</span><span class="s1">&#39;ls&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_ls</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                                        <span class="n">total</span><span class="p">,</span>
                                        <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="n">bottom</span><span class="o">=</span><span class="n">view_y_bottom</span><span class="p">)</span>

        <span class="n">folded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">pcolormesh</span><span class="p">(</span>\
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                                            <span class="bp">self</span><span class="o">.</span><span class="n">expected_spectrum_folded</span><span class="p">,</span>
                                            <span class="n">cmap</span> <span class="o">=</span> <span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;inferno&#39;</span><span class="p">),</span>
                                            <span class="n">linewidth</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                                            <span class="n">rasterized</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_rasterized</span><span class="p">)</span>

        <span class="n">folded</span><span class="o">.</span><span class="n">set_edgecolor</span><span class="p">(</span><span class="s1">&#39;face&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                           <span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]])</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">folded</span><span class="p">,</span>
                                           <span class="n">cax</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_cb</span><span class="p">,</span>
                                           <span class="n">ticks</span><span class="o">=</span><span class="n">_get_default_locator</span><span class="p">(</span><span class="kc">None</span><span class="p">),</span>
                                           <span class="nb">format</span><span class="o">=</span><span class="n">_get_default_formatter</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_spectrum_folded_cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">label</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;counts/s&#39;</span><span class="p">,</span> <span class="n">labelpad</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_folded_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="p">,</span>
          <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">expected_counts</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">exposure_time</span><span class="p">,</span>
          <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="n">total</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">component</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expected_spectrum_folded_1d</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">total</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">=</span> <span class="n">component</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">total</span> <span class="o">+=</span> <span class="n">component</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_add_folded_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="p">,</span> <span class="n">total</span><span class="p">,</span>
                                  <span class="o">**</span><span class="n">expectation_line_kwargs</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">ax</span> <span class="ow">in</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_folded_1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">]:</span>
            <span class="n">locmaj</span> <span class="o">=</span> <span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">numticks</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_locator</span><span class="p">(</span><span class="n">locmaj</span><span class="p">)</span>

            <span class="n">locmin</span> <span class="o">=</span> <span class="n">LogLocator</span><span class="p">(</span><span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span> <span class="n">subs</span><span class="o">=</span><span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span><span class="o">*</span><span class="mf">0.1</span><span class="p">,</span>
                                <span class="n">numticks</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">locmin</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_formatter</span><span class="p">(</span><span class="n">NullFormatter</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">_add_pulse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">signal</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add signal line as a function of phase. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span> <span class="n">_np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">signal</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_incident_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add incident spectrum line as a function of energy. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_energies</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_add_folded_spectrum</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add folded spectrum line as a function of channel. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">ls</span><span class="o">=</span><span class="s1">&#39;-&#39;</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">))</span>

        <span class="n">ax</span><span class="o">.</span><span class="n">step</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_pulse</span><span class="o">.</span><span class="n">instrument</span><span class="o">.</span><span class="n">channels</span><span class="p">,</span> <span class="n">spectrum</span><span class="p">,</span>
                  <span class="n">where</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding credible intervals on source photon flux &#39;</span>
                  <span class="s1">&#39;signal as function of phase&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Credible intervals added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_source_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add contours to 1D source photon flux signal axes objects. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_contours</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d_cb</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\pi(\mathrm{photons/cm}^</span><span class="si">{2}</span><span class="s1">\mathrm{/s};\phi)$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_source_1d_cb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding credible intervals on source count rate &#39;</span>
                  <span class="s1">&#39;signal as function of phase&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Credible intervals added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_folded_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add contours to 1D source photon flux signal axes objects. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_contours</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_phases</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d_cb</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_folded_1d_cb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\pi(\mathrm{counts/s};\phi)$&#39;</span><span class="p">)</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Adding credible intervals on source photon specific flux &#39;</span>
                  <span class="s1">&#39;spectrum&#39;</span><span class="p">,</span>
                  <span class="s1">&#39;Credible intervals added&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">add_spectrum_contours</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Add contours to 1D source photon flux signal axes objects. &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_contours</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_energies</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident</span><span class="p">,</span>
                           <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident_cb</span><span class="p">,</span>
                           <span class="n">logspace_y</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">cmap</span><span class="o">=</span><span class="s1">&#39;RdPu_r&#39;</span><span class="p">,</span>
                           <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">label</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\pi(\mathrm{photons/keV/cm}^</span><span class="si">{2}</span><span class="s1">\mathrm{/s};E)$&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_ax_spectrum_incident_cb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="n">label</span><span class="p">)</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">_add_contours</span><span class="p">(</span><span class="n">callback</span><span class="p">,</span> <span class="n">thetas</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">ax</span><span class="p">,</span> <span class="n">ax_cb</span><span class="p">,</span>
                      <span class="n">logspace_y</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tqdm_kwargs</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disable&#39;</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span>
                      <span class="n">parallel</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Plot contours with :mod:`fgivenx`.</span>

<span class="sd">        In order to increase control, we bypass direct use of some functions</span>
<span class="sd">        from :mod:`fgivenx.drivers`.</span>

<span class="sd">        Avoid fgivenx caching until it can also be implemented for other</span>
<span class="sd">        derived quantities which are need outside of fgivenx.</span>

<span class="sd">        .. todo::</span>

<span class="sd">            Determine whether parallelistion is straighforwardly possible</span>
<span class="sd">            within :mod:`fgivenx` given that the callback is complicated</span>
<span class="sd">            object. Currently ``OpenMP`` threading is enabled by the</span>
<span class="sd">            likelihood object instead.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">fsamps</span> <span class="o">=</span> <span class="n">fgivenx</span><span class="o">.</span><span class="n">drivers</span><span class="o">.</span><span class="n">compute_samples</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="n">callback</span><span class="p">,</span>
                                                 <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span>
                                                 <span class="n">samples</span><span class="o">=</span><span class="n">thetas</span><span class="p">,</span>
                                                 <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                                                 <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
                                                 <span class="n">tqdm_kwargs</span><span class="o">=</span><span class="n">tqdm_kwargs</span><span class="p">)</span>

        <span class="n">ymin</span> <span class="o">=</span> <span class="n">fsamps</span><span class="p">[</span><span class="o">~</span><span class="n">_np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fsamps</span><span class="p">)]</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ymin</span> <span class="o">*=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale_ymin&#39;</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">=</span> <span class="n">fsamps</span><span class="p">[</span><span class="o">~</span><span class="n">_np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">fsamps</span><span class="p">)]</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        <span class="n">ymax</span> <span class="o">*=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale_ymax&#39;</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logspace_y</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">ymin</span><span class="p">,</span> <span class="n">ymax</span><span class="p">,</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ny&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">logspace</span><span class="p">(</span><span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ymin</span><span class="p">),</span>
                             <span class="n">_np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">ymax</span><span class="p">),</span>
                             <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ny&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="p">),</span>
                             <span class="n">base</span><span class="o">=</span><span class="mf">10.0</span><span class="p">)</span>

        <span class="n">pmf</span> <span class="o">=</span> <span class="n">fgivenx</span><span class="o">.</span><span class="n">mass</span><span class="o">.</span><span class="n">compute_pmf</span><span class="p">(</span><span class="n">fsamps</span><span class="o">=</span><span class="n">fsamps</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">parallel</span><span class="o">=</span><span class="n">parallel</span><span class="p">,</span>
                                       <span class="n">cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">tqdm_kwargs</span><span class="o">=</span><span class="n">tqdm_kwargs</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">fgivenx</span><span class="o">.</span><span class="n">plot</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="o">=</span><span class="n">pmf</span><span class="p">,</span>
                             <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span>
                             <span class="n">colors</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;RdPu_r&#39;</span><span class="p">)),</span>
                             <span class="n">lines</span><span class="o">=</span><span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;lines_on&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
                             <span class="n">rasterize_contours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                             <span class="n">smooth</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">cb</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">ax_cb</span><span class="p">,</span> <span class="n">ticks</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_frame_on</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_minor_locator</span><span class="p">(</span><span class="n">AutoMinorLocator</span><span class="p">())</span>
        <span class="k">if</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;add_label&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">):</span>
            <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="sa">r</span><span class="s1">&#39;$1\sigma$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$2\sigma$&#39;</span><span class="p">,</span>
                                            <span class="sa">r</span><span class="s1">&#39;$3\sigma$&#39;</span><span class="p">])</span>

    <span class="nd">@make_verbose</span><span class="p">(</span><span class="s1">&#39;Writing to disk&#39;</span><span class="p">,</span> <span class="s1">&#39;Written&#39;</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">savefig</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_dir</span><span class="p">,</span> <span class="n">file_root</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Write figure to file. &quot;&quot;&quot;</span>

        <span class="n">filename</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span>
                                 <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;__signalplot_residuals&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_data</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span>
                                 <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;__signalplot_source&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_source</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">filename</span> <span class="o">=</span> <span class="n">_os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">base_dir</span><span class="p">,</span>
                                 <span class="n">file_root</span> <span class="o">+</span> <span class="s1">&#39;__signalplot_spectrum&#39;</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_fig_spectrum</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">EMCBackend</span><span class="p">(</span><span class="n">Run</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Prepare `emcee`_ samples for use with :mod:`getdist`.</span>

<span class="sd">    .. _emcee: http://dfm.io/emcee/current/</span>

<span class="sd">    .. todo::</span>
<span class="sd">        Update to ensure compatibility, although nested sampling is</span>
<span class="sd">        recommended and has most features.</span>

<span class="sd">    :param backend: A :class:`emcee.backends.HDFBackend` instance.</span>

<span class="sd">    :param list names: An ordered list of ``str`` parameter names.</span>
<span class="sd">                       The ordering must match the parameter vector </span>
<span class="sd">                       ordering defined in :obj:`backend`.</span>

<span class="sd">    :param int burn: If ``None``, defaults to the minumum of zero.</span>

<span class="sd">    :param int thin: If ``None``, defaults to the minumum of one.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">backend</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span> <span class="n">burn</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span>
                 <span class="n">lines</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">walker_discard</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">settings</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">truths</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">SampleContainer</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ID</span><span class="p">,</span> <span class="n">names</span><span class="p">,</span> <span class="n">bounds</span><span class="p">,</span> <span class="n">labels</span><span class="p">,</span>
                                  <span class="n">lines</span><span class="p">,</span> <span class="n">contours</span><span class="p">,</span> <span class="n">truths</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">backend</span> <span class="o">=</span> <span class="n">backend</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_mcsamples</span> <span class="o">=</span> <span class="n">MCSamples</span><span class="p">(</span><span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_extract_samples</span><span class="p">(</span><span class="n">burn</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">walker_discard</span><span class="p">),</span>
                                    <span class="n">names</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">names</span><span class="p">,</span>
                                    <span class="n">ranges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bounds</span><span class="p">,</span>
                                    <span class="n">labels</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">labels</span><span class="p">,</span>
                                    <span class="n">settings</span> <span class="o">=</span> <span class="n">settings</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_extract_samples</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">burn</span><span class="p">,</span> <span class="n">thin</span><span class="p">,</span> <span class="n">walker_discard</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Extract samples from a :class:`~emcee.backends.HDFBackend` instance.</span>

<span class="sd">        :param int burn: Number of iterations to discard from the start of the</span>
<span class="sd">                         sampling process. Can be ``&#39;last&#39;``, in which case</span>
<span class="sd">                         only the last ensemble state is used; in this case</span>
<span class="sd">                         :obj:`thin` is ignored.</span>

<span class="sd">        :param int thin: Number of iterations to thin by to reduce</span>
<span class="sd">                         autocorrelation between samples such that they are</span>
<span class="sd">                         approximately i.i.d.</span>

<span class="sd">        :param walker_discard: A :class:`numpy.ndarray` of walker numbers to</span>
<span class="sd">                               discard from the flattened set of samples. This</span>
<span class="sd">                               is useful if a subset of walkers get stuck in</span>
<span class="sd">                               parameter space due to complex structures and</span>
<span class="sd">                               an inefficient proposal distribution for</span>
<span class="sd">                               global mapping when such structure exists.</span>
<span class="sd">                               If ``None`` no walkers are discarded.</span>

<span class="sd">        :return: An ``s x d`` :class:`numpy.ndarray` of samples, where ``n`` is</span>
<span class="sd">                 the number of samples and ``d`` is the number of parameters.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">discard</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">burn</span><span class="p">),</span>
                                             <span class="n">thin</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">thin</span><span class="p">),</span>
                                             <span class="n">flat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">burn</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">burn</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span> <span class="n">thin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">thin</span> <span class="o">=</span> <span class="mi">1</span>

            <span class="n">samples</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">backend</span><span class="o">.</span><span class="n">get_chain</span><span class="p">(</span><span class="n">discard</span> <span class="o">=</span> <span class="n">burn</span><span class="p">,</span>
                                             <span class="n">thin</span> <span class="o">=</span> <span class="n">thin</span><span class="p">,</span>
                                             <span class="n">flat</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">walker_discard</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">walkers</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="n">walkers</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">walkers</span><span class="p">,</span> <span class="n">walker_discard</span><span class="p">)</span>
                <span class="n">samples</span> <span class="o">=</span> <span class="n">samples</span><span class="p">[:,</span><span class="n">walkers</span><span class="p">,:]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Invalid indexing instructions for discarding walkers.&#39;</span><span class="p">)</span>
                <span class="k">raise</span>

        <span class="n">s</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
        <span class="n">s</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">_np</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">samples</span><span class="o">.</span><span class="n">shape</span><span class="p">[:</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">samples</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the :class:`emcee.backends.HDFBackend` instance. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span>

    <span class="nd">@backend</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">backend</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the sample storage backend. &quot;&quot;&quot;</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">from</span> <span class="nn">emcee.backends</span> <span class="k">import</span> <span class="n">HDFBackend</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="s1">&#39;Check your ``emcee`` installation.&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HDFBackend</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Incompatible backend for samples.&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_backend</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Get the reader. &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span>

    <span class="nd">@reader</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">reader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot; Set the reader. &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">HDFBackend</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reader</span> <span class="o">=</span> <span class="n">obj</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;Invalid backend object.&#39;</span><span class="p">)</span>



</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Thomas E. Riley

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>